<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>SoftReference Read-Write Cache для Hibernate — с «хвостами» для реализации кластера / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.0f7bdd8f.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.670ab961.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.01bb2993.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.76acc47b.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-f458c7c4.e48e8f79.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-f458c7c4.6e221df6.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.0f7bdd8f.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.01bb2993.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-f458c7c4.e48e8f79.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.4f7c12b4e1b1b4c0e44ef6f9f33b1f9f.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/91333\/"},"headline":"SoftReference Read-Write Cache для Hibernate — с «хвостами» для реализации кластера","datePublished":"2010-04-26T15:53:10+04:00","dateModified":"2010-04-29T00:32:37+04:00","author":{"@type":"Person","name":"Сергей Владимиров"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"В этом топике попробую рассказать о реализации системы кеширования данных в CMS ArpSite. Эта подсистема уже не раз переписывалась, но она является именно тем, чт...","url":"https:\/\/habr.com\/ru\/post\/91333\/#post-content-body","about":["h_java","f_develop"],"image":["https:\/\/habr.com\/share\/publication\/91333\/1888553357c2ccf0e1fcfebee5624b3e\/"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.47.1">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="SoftReference Read-Write Cache для Hibernate — с «хвостами» для реализации кластера" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="SoftReference Read-Write Cache для Hibernate — с «хвостами» для реализации кластера" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="SoftReference Read-Write Cache для Hibernate — с «хвостами» для реализации кластера" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="В этом топике попробую рассказать о реализации системы кеширования данных в CMS ArpSite. Эта подсистема уже не раз переписывалась, но она является именно тем, что позволяет системе вообще работать с..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="В этом топике попробую рассказать о реализации системы кеширования данных в CMS ArpSite. Эта подсистема уже не раз переписывалась, но она является именно тем, что позволяет системе вообще работать с..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="В этом топике попробую рассказать о реализации системы кеширования данных в CMS ArpSite. Эта подсистема уже не раз переписывалась, но она является именно тем, что позволяет системе вообще работать с..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="В этом топике попробую рассказать о реализации системы кеширования данных в CMS ArpSite. Эта подсистема уже не раз переписывалась, но она является именно тем, что позволяет системе вообще работать с..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="В этом топике попробую рассказать о реализации системы кеширования данных в CMS ArpSite. Эта подсистема уже не раз переписывалась, но она является именно тем, что позволяет системе вообще работать с..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/91333/1888553357c2ccf0e1fcfebee5624b3e/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/91333/1888553357c2ccf0e1fcfebee5624b3e/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/91333/1888553357c2ccf0e1fcfebee5624b3e/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/91333/1888553357c2ccf0e1fcfebee5624b3e/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/91333/1888553357c2ccf0e1fcfebee5624b3e/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="91333" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2010-04-26T11:53:10.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/91333/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/91333/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/91333/1888553357c2ccf0e1fcfebee5624b3e/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.cee85629.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
              Как стать автором
            </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.cee85629.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.cee85629.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.cee85629.svg#pull-arrow"></use></svg></div></div> <!----> <div class="tm-page-article__body"><article class="tm-page-article__content tm-page-article__content_inner"><div class="tm-page-article__head-wrapper"><!----> <div class="tm-article-snippet tm-page-article__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/vlsergey/" title="vlsergey" class="tm-user-info__userpic"><div class="tm-entity-image"><svg height="24" width="24" class="tm-svg-img tm-image-placeholder tm-image-placeholder_pink"><!----> <use xlink:href="/img/megazord-v24.cee85629.svg#placeholder-user"></use></svg></div></a> <span class="tm-user-info__user"><a href="/ru/users/vlsergey/" class="tm-user-info__username">
      vlsergey
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2010-04-26T11:53:10.000Z" title="2010-04-26, 15:53">26  апреля  2010 в 15:53</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>SoftReference Read-Write Cache для Hibernate — с «хвостами» для реализации кластера</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/java/" class="tm-article-snippet__hubs-item-link"><span>Java</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml">В этом топике попробую рассказать о реализации системы кеширования данных в CMS ArpSite. Эта подсистема уже не раз переписывалась, но она является именно тем, что позволяет системе вообще работать с приемлимым временем отклика.<br/>
<br/>
Использование SoftReference даёт возможность оставить поведение кеширования «на самотёк» — за пореблением памяти следит сама JVM, она же очищает старые элементы.<br/>
<br/>
«Cluster» означает, что кеш самостоятельно отслеживает события инвалидации (устаревания, обновления) значений и следит за тем, чтобы на других серверах в кластере устаревшие элементы выкидывались из кеша. Есть и другие определения кластерного кеша. Например, основной режим работы JBoss Cache может даже «вытягивать» элементы с других узлов кластера, если их нет на текущей машине. Но для нашей системы, где скорость получения элемента с другой машины ненамного меньше скорости генерации элемента, достаточно инвалидации.<br/>
<br/>
Read-Write означает, что мы не используем блокировку элементов кеша и вообще не думаем (почти) о том, что в нашей системе есть какие-то независимые транзакции. Для CMS это нормально, но, разумеется, для какого-нибудь enterprise application это было бы недопустимо.<br/>
<a name="habracut"></a><br/>
В настоящий момент кеширование в ArpSite разделяется на три уровня:<br/>
<ul>
<li>Кеширование сгенерированных страниц</li>
<li>Остальные кеши</li>
<li>Кеширование данных</li>
</ul><br/>
Остальные кеши не случайно находятся по середине. Сгененрированные страницы это то, что будет отдано пользователю немедленно — если совпадёт URL и некоторые другие параметры. Обращений к базе для этого не нужно вообще. Кеширование данных — это то, что сейчас называется кешем второго уровня (<a href="http://www.javabeat.net/articles/37-introduction-to-hibernate-caching-1.html">second level cache</a>) в Hibernate — кешируются отдельные строки базы данных (по ключу) и некоторые популярные запросы к базе данных (по аргументам). Под остальными кешами понимаются различные механизмы кеширования промежуточных результатов генерирования страниц, кеширования таблиц стилей XSLT, кусочков XML и прочих.<br/>
<br/>
В случае, если в системе происходит какое-либо изменение, нам нужно очищать кеши. Для этого система при каждом изменении данных генерирует одно или несколько событий (event'ов). Эти события асинхронно рассылаются по остальным нодам кластера, после чего кеши реагируют на эти события полной очисткой или иинвалидацией отдельных элементов.<br/>
<br/>
Чем меньше воздействие событий на кеш, тем лучше он работает. Очевидно, что кеш сгенерированных страниц очищается <i>при любом изменении</i> — пытаться анализировать зависимости элементов страницы от конкретных строк базы данных слишком дорого.<br/>
<br/>
Кеш данных свой на каждом сервере. И раньше, до внедрения кеша на JGroups, если какое-то событие происходило, то приложение вызывало команды инвалидации кеша данных или его полной очистки на основании информации из пришедшего события. Подобная процедура работала, но имела серьёзный недостаток — любое кеширование данных требовало либо очень детально продумывать процедуру реакции на события, либо просто очищать кеш по каждому изменению. То, что сейчас и происходит в «остальных» кешах. Особенно проблемно было писать кеширование отдельных запросов к базе данных — нужно было запоминать, какие таблицы используются в запросе и очищать кеш, когда данные в этих таблицах поменялись. И подобный код нужно было писать для каждого запроса, который мы хотим закешировать…<br/>
<br/>
Но ведь это то, что Hibernate уже делает самостоятельно! Hibernate знает о том, какие кеши нужно очищать при том или ином изменении данных, и нужно всего лишь «подсмотреть», что он делает на одной ноде, и сделать тоже самое — на остальных.<br/>
<br/>
<h4>Новый Cache API для Hibernate</h4><br/>
В терминологии Hibernate один Cache — это отдельный кусок кеша, содержащий набор одинаково типизированных данных. Например, данных из одной таблицы, либо данных, например, сразу по всем закешированным запросам к базе данных. Для того, чтобы управлять поведением кеширования в Hibernate, программист указывает какой CacheProvider использовать. Это может быть, например, EhCacheProvider или тривиальные HashtableCacheProvider или NoCacheProvider.<br/>
<br/>
В версии 3.3 Hibernate ввёл новый API для кеширования, разделив один старый интерфейс Cache на несколько:<br/>
<a href="http://fisheye.jboss.org/browse/Hibernate/core/tags/hibernate-3.5.0-Final/core/src/main/java/org/hibernate/cache/Region.java?r=19148">Region</a><br/>
** <a href="http://fisheye.jboss.org/browse/Hibernate/core/tags/hibernate-3.5.0-Final/core/src/main/java/org/hibernate/cache/GeneralDataRegion.java?r=19148">General Data Region</a><br/>
**** <a href="http://fisheye.jboss.org/browse/Hibernate/core/tags/hibernate-3.5.0-Final/core/src/main/java/org/hibernate/cache/QueryResultsRegion.java?r=19148">Query Results Region</a><br/>
**** <a href="http://fisheye.jboss.org/browse/Hibernate/core/tags/hibernate-3.5.0-Final/core/src/main/java/org/hibernate/cache/TimestampsRegion.java?r=19148">Timestamps Region</a><br/>
** <a href="http://fisheye.jboss.org/browse/Hibernate/core/tags/hibernate-3.5.0-Final/core/src/main/java/org/hibernate/cache/TransactionalDataRegion.java?r=19148">Transactional Data Region</a><br/>
**** <a href="http://fisheye.jboss.org/browse/Hibernate/core/tags/hibernate-3.5.0-Final/core/src/main/java/org/hibernate/cache/CollectionRegion.java?r=19148">Collection Region</a><br/>
**** <a href="http://fisheye.jboss.org/browse/Hibernate/core/tags/hibernate-3.5.0-Final/core/src/main/java/org/hibernate/cache/EntityRegion.java?r=19148">Entity Region</a><br/>
<br/>
Также каждый Region теперь предоставляет методы для работы вне контекста (destroy, getSize, getName()), General Data Region — стандартные методы get / put, а transaction data region организует работу с данными через паттерн Strategy — <a href="http://fisheye.jboss.org/browse/Hibernate/core/tags/hibernate-3.5.0-Final/core/src/main/java/org/hibernate/cache/access/CollectionRegionAccessStrategy.java?r=19148">CollectionRegionAccessStrategy</a> для Collection Region и <a href="http://fisheye.jboss.org/browse/Hibernate/core/tags/hibernate-3.5.0-Final/core/src/main/java/org/hibernate/cache/access/EntityRegionAccessStrategy.java?r=19148">EntityRegionAccessStrategy</a> для Entity Region. Эти интерфейсы содержат, в числе прочего, команды для управления блокировками данных в рамках транзакций.<br/>
<br/>
У нас уже был раньше кеш для Hibernate, основанный на старом API. Но от него пришлось отказаться, так как старый API не позволял отличить добавление данных в кеш из базы данных от их обновления (так как они устарели). Поэтому первым шагом была реализация нового API, но уже на основе Region / Strategy. Большую помощь оказало то, что Hibernate имеет реализации адаптеров из нового API в старый. Можно просто подсмотреть реализацию, например, EntityRegionAccessStrategy на основе non-transaction cache. Что и было сделано.<br/>
<br/>
Основу API составляет Region:<br/>
<blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a><font color="black"><ol>
<li><font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean {</li>
<li> </li>
<li>  <font color="#008000">/**</font></li>
<li><font color="#008000">   * Default no-operation implementation of {@link ArpSiteRegionListener}.</font></li>
<li><font color="#008000">   * Will be replaced by cluster listener if cluster extension is installed</font></li>
<li><font color="#008000">   * </font></li>
<li><font color="#008000">   * @author vlsergey {at} gmail {dot} com</font></li>
<li><font color="#008000">   */</font></li>
<li>  <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener {</li>
<li>    <font color="#0000ff">@Override</font></li>
<li>    <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() {</li>
<li>      <font color="#008000">// noop</font></li>
<li>    }</li>
<li> </li>
<li>    <font color="#0000ff">@Override</font></li>
<li>    <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) {</li>
<li>      <font color="#008000">// noop</font></li>
<li>    }</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0);</li>
<li> </li>
<li>  <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0);</li>
<li> </li>
<li>  <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong();</li>
<li> </li>
<li>  <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener();</li>
<li> </li>
<li>  <font color="#0000ff">private</font> final Map&lt;Object, Object> map;</li>
<li> </li>
<li>  <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0);</li>
<li> </li>
<li>  <font color="#0000ff">private</font> final String regionName;</li>
<li> </li>
<li>  <font color="#008000">/**</font></li>
<li><font color="#008000">   * @param regionName</font></li>
<li><font color="#008000">   *      The name of the cache region.</font></li>
<li><font color="#008000">   * @param useHardReferences</font></li>
<li><font color="#008000">   *      &lt;code>true&lt;/code> if cache must use hard references instead of</font></li>
<li><font color="#008000">   *      {@link java.lang.ref.SoftReference}s. &lt;code>false&lt;/code></font></li>
<li><font color="#008000">   *      otherwise.</font></li>
<li><font color="#008000">   */</font></li>
<li>  @SuppressWarnings(<font color="#A31515">"unchecked"</font>)</li>
<li>  SoftRegion(String regionName, boolean useHardReferences) {</li>
<li>    <font color="#0000ff">this</font>.regionName = regionName;</li>
<li> </li>
<li>    <font color="#0000ff">if</font> (useHardReferences) {</li>
<li>      map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object>();</li>
<li>    } <font color="#0000ff">else</font> {</li>
<li>      map = Collections</li>
<li>          .&lt;Object, Object> synchronizedMap(<font color="#0000ff">new</font> ReferenceMap(</li>
<li>              ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font>));</li>
<li>    }</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() {</li>
<li>    map.clear();</li>
<li>    clears.incrementAndGet();</li>
<li>    listener.onClear();</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> boolean contains(Object key) {</li>
<li>    Object value = map.get(key);</li>
<li>    <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font>) {</li>
<li>      <font color="#008000">// to let JVM know it shall not GC it because of timeout</font></li>
<li>      value.hashCode();</li>
<li>      <font color="#0000ff">return</font> <font color="#0000ff">true</font>;</li>
<li>    }</li>
<li>    <font color="#0000ff">return</font> <font color="#0000ff">false</font>;</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException {</li>
<li>    map.clear();</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">protected</font> Object get(Object key) {</li>
<li>    final Object result = map.get(key);</li>
<li> </li>
<li>    <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font>) {</li>
<li>      miss.incrementAndGet();</li>
<li>    } <font color="#0000ff">else</font> {</li>
<li>      hits.incrementAndGet();</li>
<li>    }</li>
<li> </li>
<li>    <font color="#0000ff">return</font> result;</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() {</li>
<li>    <font color="#0000ff">return</font> miss.get();</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() {</li>
<li>    <font color="#0000ff">return</font> map.size();</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() {</li>
<li>    <font color="#0000ff">return</font> clears.get();</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() {</li>
<li>    <font color="#0000ff">return</font> map.size();</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() {</li>
<li>    <font color="#0000ff">return</font> 0;</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() {</li>
<li>    <font color="#0000ff">return</font> hits.get() + miss.get();</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() {</li>
<li>    <font color="#0000ff">return</font> hits.get();</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() {</li>
<li>    <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font>.hits.get();</li>
<li>    <font color="#0000ff">long</font> total = hits + miss.get();</li>
<li>    <font color="#0000ff">if</font> (total == 0) {</li>
<li>      <font color="#0000ff">return</font> 0;</li>
<li>    }</li>
<li>    <font color="#0000ff">return</font> (<font color="#0000ff">int</font>) (hits * 100 / total);</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> String getName() {</li>
<li>    <font color="#0000ff">return</font> regionName;</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() {</li>
<li>    <font color="#0000ff">return</font> -1;</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() {</li>
<li>    <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font></li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() {</li>
<li>    final <font color="#0000ff">long</font> next = Timestamper.next();</li>
<li>    lastTimestamp.set(next);</li>
<li>    <font color="#0000ff">return</font> next;</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) {</li>
<li>    map.put(key, value);</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) {</li>
<li>    map.remove(key);</li>
<li>    listener.onRemove(key);</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) {</li>
<li>    <font color="#0000ff">this</font>.listener = listener;</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> Map&lt;?, ?> toMap() {</li>
<li>    <font color="#0000ff">return</font> Collections.unmodifiableMap(map);</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> String toString() {</li>
<li>    <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font></li>
<li>        + <font color="#0000ff">this</font>.getSizeInMemory() + <font color="#A31515">']'</font>;</li>
<li>  }</li>
<li> </li>
<li>}</li>
</ol></font><font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font>.</font></code></blockquote><br/>
Реализация основных методов довольна тривиальна. Мы реализуем интерфейс <a href="http://arpsite.svn.sourceforge.net/viewvc/arpsite/trunk/modules/core/hibernate-cache/src/main/java/ru/arptek/arpsite/data/cache/ArpSiteRegion.java?revision=680&amp;view=markup&amp;pathrev=893">ArpSiteRegion</a>, так как он содержит дополнительный метод setListener(), который нам позже понадобится для реализации работы в кластере. Методы nextTimestamp/getTimeout нам потребуются для TimestampRegionImpl. Дополнительные методы вроде getClearCalls/getBuildCalls/getHitsPercent/clear определены в интерфейсе <a href="http://arpsite.svn.sourceforge.net/viewvc/arpsite/trunk/modules/core/commons/src/main/java/ru/arptek/common/Cache.java?revision=332&amp;view=markup">Cache</a> нашего приложения и нужны для управления кешем через <a href="http://arpsite.svn.sourceforge.net/viewvc/arpsite/trunk/modules/core/commons/src/main/java/ru/arptek/common/CacheMBean.java?revision=11&amp;view=markup">JMX</a>. Hibernate, к сожалению, подобный функционал не предоставляет. Да и откуда он знает про особенности нашего кеша ;)<br/>
<br/>
<a href="http://arpsite.svn.sourceforge.net/viewvc/arpsite/trunk/modules/core/hibernate-cache/src/main/java/ru/arptek/arpsite/data/cache/SoftCollectionRegion.java?revision=819&amp;view=markup">SoftCollectionRegion</a> и <a href="http://arpsite.svn.sourceforge.net/viewvc/arpsite/trunk/modules/core/hibernate-cache/src/main/java/ru/arptek/arpsite/data/cache/SoftEntityRegion.java?revision=819&amp;view=markup">SoftEntityRegion</a> являются очень похожими, поэтому приведу только второй из них:<br/>
<blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a><font color="black"><ol>
<li><font color="#0000ff">class</font> SoftEntityRegion extends SoftTransactionalDataRegion implements</li>
<li>    EntityRegion {</li>
<li> </li>
<li>  <font color="#008000">/**</font></li>
<li><font color="#008000">   * @param regionName</font></li>
<li><font color="#008000">   *      The name of the cache region.</font></li>
<li><font color="#008000">   */</font></li>
<li>  SoftEntityRegion(String regionName,</li>
<li>      CacheDataDescription cacheDataDescription) {</li>
<li>    super(regionName, cacheDataDescription);</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> EntityRegionAccessStrategy buildAccessStrategy(AccessType accessType) {</li>
<li>    <font color="#0000ff">return</font> <font color="#0000ff">new</font> EntityRegionAccessStrategy() {</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> boolean afterInsert(Object key, Object value, Object version) {</li>
<li>        <font color="#0000ff">return</font> <font color="#0000ff">false</font>;</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> boolean afterUpdate(Object key, Object value,</li>
<li>          Object currentVersion, Object previousVersion, SoftLock <font color="#0000ff">lock</font>) {</li>
<li>        SoftEntityRegion.<font color="#0000ff">this</font>.remove(key);</li>
<li>        <font color="#0000ff">return</font> <font color="#0000ff">false</font>;</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> <font color="#0000ff">void</font> evict(Object key) {</li>
<li>        SoftEntityRegion.<font color="#0000ff">this</font>.remove(key);</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> <font color="#0000ff">void</font> evictAll() {</li>
<li>        SoftEntityRegion.<font color="#0000ff">this</font>.clear();</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> Object get(Object key, <font color="#0000ff">long</font> txTimestamp) {</li>
<li>        <font color="#0000ff">return</font> SoftEntityRegion.<font color="#0000ff">this</font>.get(key);</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> EntityRegion getRegion() {</li>
<li>        <font color="#0000ff">return</font> SoftEntityRegion.<font color="#0000ff">this</font>;</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> boolean insert(Object key, Object value, Object version) {</li>
<li>        <font color="#0000ff">return</font> <font color="#0000ff">false</font>;</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> SoftLock lockItem(Object key, Object version) {</li>
<li>        <font color="#0000ff">return</font> <font color="#0000ff">null</font>;</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> SoftLock lockRegion() {</li>
<li>        <font color="#0000ff">return</font> <font color="#0000ff">null</font>;</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> boolean putFromLoad(Object key, Object value,</li>
<li>          <font color="#0000ff">long</font> txTimestamp, Object version) {</li>
<li>        SoftEntityRegion.<font color="#0000ff">this</font>.put(key, value);</li>
<li>        <font color="#0000ff">return</font> <font color="#0000ff">true</font>;</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> boolean putFromLoad(Object key, Object value,</li>
<li>          <font color="#0000ff">long</font> txTimestamp, Object version, boolean minimalPutOverride) {</li>
<li>        <font color="#0000ff">if</font> (minimalPutOverride &amp;&amp; contains(key)) {</li>
<li>          <font color="#0000ff">return</font> <font color="#0000ff">false</font>;</li>
<li>        }</li>
<li> </li>
<li>        SoftEntityRegion.<font color="#0000ff">this</font>.put(key, value);</li>
<li>        <font color="#0000ff">return</font> <font color="#0000ff">true</font>;</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) {</li>
<li>        SoftEntityRegion.<font color="#0000ff">this</font>.remove(key);</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> <font color="#0000ff">void</font> removeAll() {</li>
<li>        SoftEntityRegion.<font color="#0000ff">this</font>.clear();</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> <font color="#0000ff">void</font> unlockItem(Object key, SoftLock <font color="#0000ff">lock</font>) {</li>
<li>        SoftEntityRegion.<font color="#0000ff">this</font>.remove(key);</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> <font color="#0000ff">void</font> unlockRegion(SoftLock <font color="#0000ff">lock</font>) {</li>
<li>        SoftEntityRegion.<font color="#0000ff">this</font>.clear();</li>
<li>      }</li>
<li> </li>
<li>      <font color="#0000ff">@Override</font></li>
<li>      <font color="#0000ff">public</font> boolean update(Object key, Object value,</li>
<li>          Object currentVersion, Object previousVersion) {</li>
<li>        SoftEntityRegion.<font color="#0000ff">this</font>.remove(key);</li>
<li>        <font color="#0000ff">return</font> <font color="#0000ff">false</font>;</li>
<li>      }</li>
<li>    };</li>
<li>  }</li>
<li> </li>
<li>}</li>
</ol></font><font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font>.</font></code></blockquote><br/>
<br/>
Основная работа выполняется через интерфейс стратегии. Идея использования отдельного интерфейса в том, что в транзакционной реализации каждая транзакция будет использовать отдельный экземпляр EntityRegionAccessStrategy. Однако у нас мы просто перенаправляем все запросы к SoftEntityRegion. Особенности реализации методов update(), unlockItem() и unlockRegion() были подсмотрены у класса EntityAccessStrategyAdapter. С точки зрения будущего «прикручивания» кластера важно отметить, что листенер из SoftRegion будет реагировать только на методы remove() и clear().<br/>
<br/>
Кто их будет вызывать? Сам Hibernate будет их вызывать в те моменты, когда закончит работать с отдельными объектами. Например, он всегда будет вызывать evict(), или же evictAll() — если мы что-то делали с помощью запросов. Именно такая предсказуемая работа с кешем и даст нам возможность в будущем легко добавить поддержку кластера — всего лишь отследив вызовы clear / remove.<br/>
<br/>
А вот с QueryCache не всё так просто. Проблема в том, что Hibernate… не удаляет старые запросы из кеша. То есть не инвалидирует значения в кеше если что-то произошло. Его поведение хитрее: рядом с QueryResultsRegion трудится TimestampsRegion, который содержит, судя по его названию, timestamp'ы последних изменений отдельных таблиц в базе данных. Поэтому если нам надо выполнить запрос к базе данных, Hibernate делает следующее:<br/>
<ol>
<li>Взять timestamp для таблицы из TimestampsRegion</li>
<li>Взять результат из QueryResultsRegion</li>
<li>У результата взять Timestamp</li>
<li>Сравнить с тем, что было взять из TimestampsRegion. Если значение больше — то результат в QueryResultsRegion считается более новым, чем последнее изменение, и его можно использовать.</li>
<li>Важно — если вTimestampsRegion нет значения для определённой таблицы, Hibernate считает, что её данные не менялись</li>
<li>Если же timestamp результата меньше, чем взятый из TimestampsRegion, то значение считается устаревшим. Однако, при этом значение не удаляется из кеша, а заменяется тем, что будет получено из базы</li>
</ol><br/>
При этом в случае каких-либо запросов на UPDATE или INSERT в TimestampsRegion будет помещён новый timestamp для таблицы, но при этом QueryCache об этом никак оповещён не будет!<br/>
<br/>
Из 5-го пункта, кстати, следует, что для нормальной работы даже без кластера ни в коему случае нельзя использовать SoftReference для хранения значений в TimestampsRegion. Даже в описании UpdateTimestampsCache сказано — "<i>we recommend that the the underlying cache not be configured for expiry at all</i>" — то есть не удалять значения из этого кеша вообще. Благо, он не очень-то много места занимает в памяти.<br/>
<br/>
Из описания выше ясно, что простой перехват clear()/remove() ничего не даст — они просто не вызываются. Перехватывать put() у QueryCache бесполезно, да и может оказаться поздно — timestamp мог уже обновиться. Поэтому возможны два варианта:<br/>
<ul>
<li>Делать полноценную реализацию TimestampsRegion на уровне кластера. А именно — отслеживать выдаваемые на каждой машине timestapm'ы и корректно их синхронизировать на уровне кластера</li>
<li>Делать грязные хаки</li>
</ul><br/>
К сожалению, первый подход для CMS Arp.Site оказался недопустим — синхронизация Timestamp предполагает некий общий счётчик вроде AtomicLong, но работающий в рамках кластера. То есть все обращения к нему должны быть синхронизированы — каждое добавления объекта в QueryCache кеш. А это очень отрицательно сказалось бы на производительности — синхронная обработка в сети намного дороже, чем асинхронная.<br/>
<br/>
Чтобы и здесь реализовать асинхронный подход, мы совершили грязный хак. А именно — мы написали TimestampCache таким образом, что он знает, какие значения Hibernate в него помещает. Это плохо — потому что Hibernate в следующей версии может и поменять тип значений. Поэтому это и называется хаком. Зато работает:<br/>
<br/>
<blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a><font color="black"><ol>
<li><font color="#0000ff">class</font> TimestampRegionImpl extends SoftRegion implements ArpSiteTimestampRegion {</li>
<li>  <font color="#008000">/**</font></li>
<li><font color="#008000">   * Default no-operation implementation of</font></li>
<li><font color="#008000">   * {@link ArpSiteTimestampRegionListener}. Will be replaced by cluster</font></li>
<li><font color="#008000">   * listener if cluster extension is installed</font></li>
<li><font color="#008000">   * </font></li>
<li><font color="#008000">   * @author vlsergey {at} gmail {dot} com</font></li>
<li><font color="#008000">   */</font></li>
<li>  <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements</li>
<li>      ArpSiteTimestampRegionListener {</li>
<li> </li>
<li>    <font color="#0000ff">@Override</font></li>
<li>    <font color="#0000ff">public</font> <font color="#0000ff">void</font> onInvalidate(Serializable space) {</li>
<li>      <font color="#008000">// no op</font></li>
<li>    }</li>
<li> </li>
<li>    <font color="#0000ff">@Override</font></li>
<li>    <font color="#0000ff">public</font> <font color="#0000ff">void</font> onPreInvalidate(Serializable space) {</li>
<li>      <font color="#008000">// no op</font></li>
<li>    }</li>
<li> </li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">private</font> ArpSiteTimestampRegionListener listener = <font color="#0000ff">new</font> NoOpListener();</li>
<li> </li>
<li>  <font color="#008000">/**</font></li>
<li><font color="#008000">   * @param regionName</font></li>
<li><font color="#008000">   *      The name of the region.</font></li>
<li><font color="#008000">   */</font></li>
<li>  TimestampRegionImpl(String regionName) {</li>
<li>    super(regionName, <font color="#0000ff">true</font>);</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> evict(Object key) {</li>
<li>    super.remove(key);</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> evictAll() {</li>
<li>    super.clear();</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> Object get(Object key) {</li>
<li>    <font color="#0000ff">return</font> super.get(key);</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> invalidate(Serializable space) {</li>
<li>    Long ts = Long.valueOf(nextTimestamp());</li>
<li>    super.put(space, ts);</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> preInvalidate(Serializable space) {</li>
<li>    Long ts = Long.valueOf(nextTimestamp() + getTimeout());</li>
<li>    super.put(space, ts);</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> put(Object key, Object value) {</li>
<li>    super.put(key, value);</li>
<li> </li>
<li>    final Serializable space = (Serializable) key;</li>
<li>    final Long timestamp = (Long) value;</li>
<li> </li>
<li>    final boolean inFuture = timestamp.longValue() > lastTimestamp.get();</li>
<li>    <font color="#0000ff">if</font> (inFuture) {</li>
<li>      listener.onPreInvalidate(space);</li>
<li>    } <font color="#0000ff">else</font> {</li>
<li>      listener.onInvalidate(space);</li>
<li>    }</li>
<li>  }</li>
<li> </li>
<li>  <font color="#0000ff">@Override</font></li>
<li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> setTimstampListener(</li>
<li>      ArpSiteTimestampRegionListener timestampListener) {</li>
<li>    <font color="#0000ff">this</font>.listener = timestampListener;</li>
<li>  }</li>
<li>}</li>
</ol></font><font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font>.</font></code></blockquote><br/>
<br/>
Основная работа делается в методе put(). Чтобы понять логику метода нужно остановиться на том, что именно делает Hibernate c timestamp cache. А именно делаются три операции:<br/>
<ul>
<li>Операция get — взять timestamp для region (скрывается за Serializable)</li>
<li>Операция invalidate — взять новый timestamp и поместить его в кеш для region </li>
<li>Операция preinvalidate — взять новый timestamp, прибавить 60 секунд и поместить в кеш</li>
</ul><br/>
Наша реализация пытается отследить, какое именно из последних двух действий выполняет Hibernate, и, в будущем, распространить данное действие на все узлы кластера. Для этого, разумеется, нам потребуется ещё один Listener (<a href="http://arpsite.svn.sourceforge.net/viewvc/arpsite/trunk/modules/core/hibernate-cache/src/main/java/ru/arptek/arpsite/data/cache/ArpSiteTimestampRegionListener.java?revision=779&amp;view=markup">ArpSiteTimestampRegionListener</a>). Разницу между invalidate и preinvalidate мы отслеживаем по тому значению, которое помещается в кеш, после чего соответствующим образом уведомляется листенер. А для кластера, для уведомления с других машин, мы сделали свои два метода (доступны через интерфейс <a href="http://arpsite.svn.sourceforge.net/viewvc/arpsite/trunk/modules/core/hibernate-cache/src/main/java/ru/arptek/arpsite/data/cache/ArpSiteTimestampRegion.java?revision=779&amp;view=markup">ArpSiteTimestampRegion</a>) invalidate и preInvalidate, которые повторяют логику Hibernate. Особенностью реализации является то, что нам не нужно знать текущие значения timestamp на разных машинах для того, чтобы инвалидировать кеши в кластере. Например, метод invalidate(region) возьмёт новый timestamp на <i>текущей</i> машине чтобы инвалидировать QueryCache на <i>текущей</i> же машине. Ему не интересно, какое было значение на той машине, где Hibernate запрашивал инвалидацию.<br/>
<br/>
Сама логика Hibernate, кстати, кому интересно, находится в классе <a href="http://fisheye.jboss.org/browse/Hibernate/core/tags/hibernate-3.5.0-Final/core/src/main/java/org/hibernate/cache/UpdateTimestampsCache.java?r=11588">UpdateTimestampsCache</a> и <a href="http://fisheye.jboss.org/browse/Hibernate/core/tags/hibernate-3.5.0-Final/core/src/main/java/org/hibernate/cache/StandardQueryCache.java?r=19148">StandardQueryCache</a>. Если они поменяется, нашу реализацию TimestampRegionImpl, возможно, придётся переписывать. Это та цена, которую мы платим за «хак».<br/>
<br/>
<h4>Продолжение следует</h4><br/>
В этом топике я описал, как сделана реализация кешей с «зарубками» на то, чтобы можно было связать между собой отдельные кеши на отдельных машинах в единое кластерное решение. Зарубки состоят в следующем:<br/>
 — классы SoftRegion и TimestampRegionImpl вызывают методы интерфейсов ArpSiteRegionListener и ArpSiteTimestampRegionListener, если нужно уведомить другие машины в кластере о происходящих событиях<br/>
 — в свою очередь через интерфейсы ArpSiteRegion и ArpSiteTimestampRegion они предоставляют возможность уведомить их о событиях в кластере.<br/>
<br/>
И хотя работа с кластером пока не описана, кеши уже рабочие.<br/>
<br/>
В следующем топике — как с помощью JGroups теперь сделать кластер.</div></div> <!----> <!----></div> <div class="tm-article-body__tags"><div class="tm-article-body__tags-links"><span class="tm-article-body__tags-title">Теги:</span> <span class="tm-article-body__tags-item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bjava%5D" class="tm-article-body__tags-item-link">java</a></span><span class="tm-article-body__tags-item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bhibernate%5D" class="tm-article-body__tags-item-link">hibernate</a></span><span class="tm-article-body__tags-item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bcache%5D" class="tm-article-body__tags-item-link">cache</a></span></div> <div class="tm-article-body__tags-links"><span class="tm-article-body__tags-title">Хабы:</span> <span class="tm-article-body__tags-item"><a href="/ru/hub/java/" class="tm-article-body__tags-item-link">
                  Java
                </a></span></div></div></article> <div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 5: ↑4 и ↓1</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-rating"></use></svg> <span title="Всего голосов 5: ↑4 и ↓1" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+3</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <!----> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    12
  </span></button> <div title="Читать комментарии" class="tm-article-comments-counter-link tm-data-icons__item"><a href="/ru/post/91333/comments/" class="tm-article-comments-counter-link__link"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value">
      23
    </span></a> <!----></div> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div></div> <!----></div> <!----> <div class="tm-page-article__additional-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body"><div class="tm-article-author tm-page-article__author"><!----> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-two-column"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/vlsergey/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><svg class="tm-svg-img tm-image-placeholder tm-image-placeholder_pink"><!----> <use xlink:href="/img/megazord-v24.cee85629.svg#placeholder-user"></use></svg></div></a> <div class="tm-user-card__meta"><div title=" 228 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    72.7
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">0</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info"><div class="tm-user-card__title"><span class="tm-user-card__name">Сергей Владимиров</span> <a href="/ru/users/vlsergey/" class="tm-user-card__nickname">
          @vlsergey
        </a> <!----></div> <p class="tm-user-card__short-info">Пользователь</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-two-column"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div></div> <!----></section> <div class="tm-page-article__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/91333/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 23 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <section class="tm-block tm-block_spacing-around"><header class="tm-block__header"><h2 class="tm-block__title">Похожие публикации</h2> <!----></header> <div class="tm-block__body"><ul class="tm-article-list-block__list"><li class="tm-article-list-block__item"><article class="tm-article-snippet-block-block tm-article-snippet-block-block_preview"><div class="tm-article-snippet-block__user-meta"><div class="tm-article-snippet-block__date"><time datetime="2021-09-20T13:11:31.000Z" title="2021-09-20, 16:11">20  сентября   в 16:11</time></div></div> <h2 class="tm-article-title tm-article-title_block"><a href="/ru/company/otus/blog/578950/" class="tm-article-title__link"><span>Hibernate Proxy — для чего используются и как получить исходный объект</span></a></h2> <div class="tm-data-icons"><!----> <div class="tm-votes-meter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_small"><title>Всего голосов 9: ↑8.5 и ↓0.5</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-rating"></use></svg> <span title="Всего голосов 9: ↑8.5 и ↓0.5" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_small">+8</span></div> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">1.7K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    18
  </span></button> <div title="Читать комментарии" class="tm-article-comments-counter-link tm-data-icons__item"><a href="/ru/company/otus/blog/578950/comments/" class="tm-article-comments-counter-link__link"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value">
      0
    </span></a> <!----></div> <!----> <DIV class="v-portal" style="display:none;"></DIV></div></article></li><li class="tm-article-list-block__item"><article class="tm-article-snippet-block-block tm-article-snippet-block-block_preview"><div class="tm-article-snippet-block__user-meta"><div class="tm-article-snippet-block__date"><time datetime="2012-01-19T15:12:16.000Z" title="2012-01-19, 19:12">19  января  2012 в 19:12</time></div></div> <h2 class="tm-article-title tm-article-title_block"><a href="/ru/post/136375/" class="tm-article-title__link"><span>Hibernate Cache. Практика</span></a></h2> <div class="tm-data-icons"><!----> <div class="tm-votes-meter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_small"><title>Всего голосов 21: ↑20 и ↓1</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-rating"></use></svg> <span title="Всего голосов 21: ↑20 и ↓1" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_small">+19</span></div> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">17K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    139
  </span></button> <div title="Читать комментарии" class="tm-article-comments-counter-link tm-data-icons__item"><a href="/ru/post/136375/comments/" class="tm-article-comments-counter-link__link"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value">
      12
    </span></a> <!----></div> <!----> <DIV class="v-portal" style="display:none;"></DIV></div></article></li><li class="tm-article-list-block__item"><article class="tm-article-snippet-block-block tm-article-snippet-block-block_preview"><div class="tm-article-snippet-block__user-meta"><div class="tm-article-snippet-block__date"><time datetime="2012-01-16T14:48:42.000Z" title="2012-01-16, 18:48">16  января  2012 в 18:48</time></div></div> <h2 class="tm-article-title tm-article-title_block"><a href="/ru/post/135176/" class="tm-article-title__link"><span>Hibernate cache</span></a></h2> <div class="tm-data-icons"><!----> <div class="tm-votes-meter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_small"><title>Всего голосов 26: ↑26 и ↓0</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-rating"></use></svg> <span title="Всего голосов 26: ↑26 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_small">+26</span></div> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">128K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    342
  </span></button> <div title="Читать комментарии" class="tm-article-comments-counter-link tm-data-icons__item"><a href="/ru/post/135176/comments/" class="tm-article-comments-counter-link__link"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value">
      28
    </span></a> <!----></div> <!----> <DIV class="v-portal" style="display:none;"></DIV></div></article></li> <!----></ul></div> <!----></section> <!----> <!----> <section class="tm-block tm-block_spacing-around"><header class="tm-block__header"><h2 class="tm-block__title">Лучшие публикации за сутки</h2> <!----></header> <div class="tm-block__body"><ul class="tm-article-list-block__list"><li class="tm-article-list-block__item"><article class="tm-article-snippet-block-block tm-article-snippet-block-block_preview"><div class="tm-article-snippet-block__user-meta"><div class="tm-article-snippet-block__date"><time datetime="2021-09-27T16:41:21.000Z" title="2021-09-27, 19:41">вчера в 19:41</time></div></div> <h2 class="tm-article-title tm-article-title_block"><a href="/ru/company/lamptest/blog/580228/" class="tm-article-title__link"><span>Идеальная светодиодная лампа за 21 рубль</span></a></h2> <div class="tm-data-icons"><!----> <div class="tm-votes-meter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_small"><title>Всего голосов 154: ↑152 и ↓2</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-rating"></use></svg> <span title="Всего голосов 154: ↑152 и ↓2" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_small">+150</span></div> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">30K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    114
  </span></button> <div title="Читать комментарии" class="tm-article-comments-counter-link tm-data-icons__item"><a href="/ru/company/lamptest/blog/580228/comments/" class="tm-article-comments-counter-link__link"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value">
      61
    </span></a> <!----></div> <!----> <DIV class="v-portal" style="display:none;"></DIV></div></article></li><li class="tm-article-list-block__item"><article class="tm-article-snippet-block-block tm-article-snippet-block-block_preview"><div class="tm-article-snippet-block__user-meta"><div class="tm-article-snippet-block__date"><time datetime="2021-09-27T13:03:14.000Z" title="2021-09-27, 16:03">вчера в 16:03</time></div></div> <h2 class="tm-article-title tm-article-title_block"><a href="/ru/company/ruvds/blog/580124/" class="tm-article-title__link"><span>Электролюминесцентные индикаторы из прошлого</span></a></h2> <div class="tm-data-icons"><!----> <div class="tm-votes-meter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_small"><title>Всего голосов 104: ↑104 и ↓0</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-rating"></use></svg> <span title="Всего голосов 104: ↑104 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_small">+104</span></div> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">8.8K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    43
  </span></button> <div title="Читать комментарии" class="tm-article-comments-counter-link tm-data-icons__item"><a href="/ru/company/ruvds/blog/580124/comments/" class="tm-article-comments-counter-link__link"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value">
      29
    </span></a> <!----></div> <!----> <DIV class="v-portal" style="display:none;"></DIV></div></article></li><li class="tm-article-list-block__item"><article class="tm-article-snippet-block-block tm-article-snippet-block-block_preview"><div class="tm-article-snippet-block__user-meta"><div class="tm-article-snippet-block__date"><time datetime="2021-09-27T12:53:02.000Z" title="2021-09-27, 15:53">вчера в 15:53</time></div></div> <h2 class="tm-article-title tm-article-title_block"><a href="/ru/post/580210/" class="tm-article-title__link"><span>PHP Дайджест № 212 (13 – 27 сентября 2021)</span></a></h2> <div class="tm-data-icons"><!----> <div class="tm-votes-meter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_small"><title>Всего голосов 54: ↑54 и ↓0</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-rating"></use></svg> <span title="Всего голосов 54: ↑54 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_small">+54</span></div> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">5.6K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    16
  </span></button> <div title="Читать комментарии" class="tm-article-comments-counter-link tm-data-icons__item"><a href="/ru/post/580210/comments/" class="tm-article-comments-counter-link__link"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value">
      1
    </span></a> <!----></div> <!----> <DIV class="v-portal" style="display:none;"></DIV></div></article></li><li class="tm-article-list-block__item"><article class="tm-article-snippet-block-block tm-article-snippet-block-block_preview"><div class="tm-article-snippet-block__user-meta"><div class="tm-article-snippet-block__date"><time datetime="2021-09-28T07:08:30.000Z" title="2021-09-28, 10:08">сегодня в 10:08</time></div></div> <h2 class="tm-article-title tm-article-title_block"><a href="/ru/company/nlmk/blog/580270/" class="tm-article-title__link"><span>Варим суп из стали: оптимизация логистики ковшей и как устроен цех КЦ № 2</span></a></h2> <div class="tm-data-icons"><!----> <div class="tm-votes-meter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_small"><title>Всего голосов 39: ↑39 и ↓0</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-rating"></use></svg> <span title="Всего голосов 39: ↑39 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_small">+39</span></div> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">2.2K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    14
  </span></button> <div title="Читать комментарии" class="tm-article-comments-counter-link tm-data-icons__item"><a href="/ru/company/nlmk/blog/580270/comments/" class="tm-article-comments-counter-link__link"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value">
      14
    </span></a> <!----></div> <!----> <DIV class="v-portal" style="display:none;"></DIV></div></article></li><li class="tm-article-list-block__item"><article class="tm-article-snippet-block-block tm-article-snippet-block-block_preview"><div class="tm-article-snippet-block__user-meta"><div class="tm-article-snippet-block__date"><time datetime="2021-09-28T08:07:48.000Z" title="2021-09-28, 11:07">сегодня в 11:07</time></div></div> <h2 class="tm-article-title tm-article-title_block"><a href="/ru/company/domclick/blog/575686/" class="tm-article-title__link"><span>Когда сделаете доработку?</span></a></h2> <div class="tm-data-icons"><!----> <div class="tm-votes-meter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_small"><title>Всего голосов 33: ↑33 и ↓0</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-rating"></use></svg> <span title="Всего голосов 33: ↑33 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_small">+33</span></div> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">1.6K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    18
  </span></button> <div title="Читать комментарии" class="tm-article-comments-counter-link tm-data-icons__item"><a href="/ru/company/domclick/blog/575686/comments/" class="tm-article-comments-counter-link__link"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.cee85629.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value">
      3
    </span></a> <!----></div> <!----> <DIV class="v-portal" style="display:none;"></DIV></div></article></li> <!----></ul></div> <!----></section> <!----> <!----></div></div></div> <div class="tm-page__sidebar"><div hl="ru" id="91333" class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/91333/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/91333/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"91333":{"id":"91333","timePublished":"2010-04-26T11:53:10+00:00","isCorporative":false,"lang":"ru","titleHtml":"SoftReference Read-Write Cache для Hibernate — с «хвостами» для реализации кластера","leadData":{"textHtml":"В этом топике попробую рассказать о реализации системы кеширования данных в CMS ArpSite. Эта подсистема уже не раз переписывалась, но она является именно тем, что позволяет системе вообще работать с приемлимым временем отклика.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИспользование SoftReference даёт возможность оставить поведение кеширования «на самотёк» — за пореблением памяти следит сама JVM, она же очищает старые элементы.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n«Cluster» означает, что кеш самостоятельно отслеживает события инвалидации (устаревания, обновления) значений и следит за тем, чтобы на других серверах в кластере устаревшие элементы выкидывались из кеша. Есть и другие определения кластерного кеша. Например, основной режим работы JBoss Cache может даже «вытягивать» элементы с других узлов кластера, если их нет на текущей машине. Но для нашей системы, где скорость получения элемента с другой машины ненамного меньше скорости генерации элемента, достаточно инвалидации.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nRead-Write означает, что мы не используем блокировку элементов кеша и вообще не думаем (почти) о том, что в нашей системе есть какие-то независимые транзакции. Для CMS это нормально, но, разумеется, для какого-нибудь enterprise application это было бы недопустимо.\u003Cbr\u002F\u003E\r\n","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"editorVersion":"1.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":72.7,"votesCount":228},"rating":0,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"42070","alias":"vlsergey","fullname":"Сергей Владимиров","avatarUrl":null,"speciality":"Пользователь"},"statistics":{"commentsCount":23,"favoritesCount":12,"readingCount":3792,"score":3,"votesCount":5},"hubs":[{"relatedData":null,"id":"375","alias":"java","type":"collective","title":"Java","titleHtml":"Java","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003EВ этом топике попробую рассказать о реализации системы кеширования данных в CMS ArpSite. Эта подсистема уже не раз переписывалась, но она является именно тем, что позволяет системе вообще работать с приемлимым временем отклика.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИспользование SoftReference даёт возможность оставить поведение кеширования «на самотёк» — за пореблением памяти следит сама JVM, она же очищает старые элементы.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n«Cluster» означает, что кеш самостоятельно отслеживает события инвалидации (устаревания, обновления) значений и следит за тем, чтобы на других серверах в кластере устаревшие элементы выкидывались из кеша. Есть и другие определения кластерного кеша. Например, основной режим работы JBoss Cache может даже «вытягивать» элементы с других узлов кластера, если их нет на текущей машине. Но для нашей системы, где скорость получения элемента с другой машины ненамного меньше скорости генерации элемента, достаточно инвалидации.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nRead-Write означает, что мы не используем блокировку элементов кеша и вообще не думаем (почти) о том, что в нашей системе есть какие-то независимые транзакции. Для CMS это нормально, но, разумеется, для какого-нибудь enterprise application это было бы недопустимо.\u003Cbr\u002F\u003E\r\n\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nВ настоящий момент кеширование в ArpSite разделяется на три уровня:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EКеширование сгенерированных страниц\u003C\u002Fli\u003E\r\n\u003Cli\u003EОстальные кеши\u003C\u002Fli\u003E\r\n\u003Cli\u003EКеширование данных\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\nОстальные кеши не случайно находятся по середине. Сгененрированные страницы это то, что будет отдано пользователю немедленно — если совпадёт URL и некоторые другие параметры. Обращений к базе для этого не нужно вообще. Кеширование данных — это то, что сейчас называется кешем второго уровня (\u003Ca href=\"http:\u002F\u002Fwww.javabeat.net\u002Farticles\u002F37-introduction-to-hibernate-caching-1.html\"\u003Esecond level cache\u003C\u002Fa\u003E) в Hibernate — кешируются отдельные строки базы данных (по ключу) и некоторые популярные запросы к базе данных (по аргументам). Под остальными кешами понимаются различные механизмы кеширования промежуточных результатов генерирования страниц, кеширования таблиц стилей XSLT, кусочков XML и прочих.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ случае, если в системе происходит какое-либо изменение, нам нужно очищать кеши. Для этого система при каждом изменении данных генерирует одно или несколько событий (event'ов). Эти события асинхронно рассылаются по остальным нодам кластера, после чего кеши реагируют на эти события полной очисткой или иинвалидацией отдельных элементов.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧем меньше воздействие событий на кеш, тем лучше он работает. Очевидно, что кеш сгенерированных страниц очищается \u003Ci\u003Eпри любом изменении\u003C\u002Fi\u003E — пытаться анализировать зависимости элементов страницы от конкретных строк базы данных слишком дорого.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКеш данных свой на каждом сервере. И раньше, до внедрения кеша на JGroups, если какое-то событие происходило, то приложение вызывало команды инвалидации кеша данных или его полной очистки на основании информации из пришедшего события. Подобная процедура работала, но имела серьёзный недостаток — любое кеширование данных требовало либо очень детально продумывать процедуру реакции на события, либо просто очищать кеш по каждому изменению. То, что сейчас и происходит в «остальных» кешах. Особенно проблемно было писать кеширование отдельных запросов к базе данных — нужно было запоминать, какие таблицы используются в запросе и очищать кеш, когда данные в этих таблицах поменялись. И подобный код нужно было писать для каждого запроса, который мы хотим закешировать…\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНо ведь это то, что Hibernate уже делает самостоятельно! Hibernate знает о том, какие кеши нужно очищать при том или ином изменении данных, и нужно всего лишь «подсмотреть», что он делает на одной ноде, и сделать тоже самое — на остальных.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003EНовый Cache API для Hibernate\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nВ терминологии Hibernate один Cache — это отдельный кусок кеша, содержащий набор одинаково типизированных данных. Например, данных из одной таблицы, либо данных, например, сразу по всем закешированным запросам к базе данных. Для того, чтобы управлять поведением кеширования в Hibernate, программист указывает какой CacheProvider использовать. Это может быть, например, EhCacheProvider или тривиальные HashtableCacheProvider или NoCacheProvider.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ версии 3.3 Hibernate ввёл новый API для кеширования, разделив один старый интерфейс Cache на несколько:\u003Cbr\u002F\u003E\r\n\u003Ca href=\"http:\u002F\u002Ffisheye.jboss.org\u002Fbrowse\u002FHibernate\u002Fcore\u002Ftags\u002Fhibernate-3.5.0-Final\u002Fcore\u002Fsrc\u002Fmain\u002Fjava\u002Forg\u002Fhibernate\u002Fcache\u002FRegion.java?r=19148\"\u003ERegion\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n** \u003Ca href=\"http:\u002F\u002Ffisheye.jboss.org\u002Fbrowse\u002FHibernate\u002Fcore\u002Ftags\u002Fhibernate-3.5.0-Final\u002Fcore\u002Fsrc\u002Fmain\u002Fjava\u002Forg\u002Fhibernate\u002Fcache\u002FGeneralDataRegion.java?r=19148\"\u003EGeneral Data Region\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n**** \u003Ca href=\"http:\u002F\u002Ffisheye.jboss.org\u002Fbrowse\u002FHibernate\u002Fcore\u002Ftags\u002Fhibernate-3.5.0-Final\u002Fcore\u002Fsrc\u002Fmain\u002Fjava\u002Forg\u002Fhibernate\u002Fcache\u002FQueryResultsRegion.java?r=19148\"\u003EQuery Results Region\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n**** \u003Ca href=\"http:\u002F\u002Ffisheye.jboss.org\u002Fbrowse\u002FHibernate\u002Fcore\u002Ftags\u002Fhibernate-3.5.0-Final\u002Fcore\u002Fsrc\u002Fmain\u002Fjava\u002Forg\u002Fhibernate\u002Fcache\u002FTimestampsRegion.java?r=19148\"\u003ETimestamps Region\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n** \u003Ca href=\"http:\u002F\u002Ffisheye.jboss.org\u002Fbrowse\u002FHibernate\u002Fcore\u002Ftags\u002Fhibernate-3.5.0-Final\u002Fcore\u002Fsrc\u002Fmain\u002Fjava\u002Forg\u002Fhibernate\u002Fcache\u002FTransactionalDataRegion.java?r=19148\"\u003ETransactional Data Region\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n**** \u003Ca href=\"http:\u002F\u002Ffisheye.jboss.org\u002Fbrowse\u002FHibernate\u002Fcore\u002Ftags\u002Fhibernate-3.5.0-Final\u002Fcore\u002Fsrc\u002Fmain\u002Fjava\u002Forg\u002Fhibernate\u002Fcache\u002FCollectionRegion.java?r=19148\"\u003ECollection Region\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n**** \u003Ca href=\"http:\u002F\u002Ffisheye.jboss.org\u002Fbrowse\u002FHibernate\u002Fcore\u002Ftags\u002Fhibernate-3.5.0-Final\u002Fcore\u002Fsrc\u002Fmain\u002Fjava\u002Forg\u002Fhibernate\u002Fcache\u002FEntityRegion.java?r=19148\"\u003EEntity Region\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТакже каждый Region теперь предоставляет методы для работы вне контекста (destroy, getSize, getName()), General Data Region — стандартные методы get \u002F put, а transaction data region организует работу с данными через паттерн Strategy — \u003Ca href=\"http:\u002F\u002Ffisheye.jboss.org\u002Fbrowse\u002FHibernate\u002Fcore\u002Ftags\u002Fhibernate-3.5.0-Final\u002Fcore\u002Fsrc\u002Fmain\u002Fjava\u002Forg\u002Fhibernate\u002Fcache\u002Faccess\u002FCollectionRegionAccessStrategy.java?r=19148\"\u003ECollectionRegionAccessStrategy\u003C\u002Fa\u003E для Collection Region и \u003Ca href=\"http:\u002F\u002Ffisheye.jboss.org\u002Fbrowse\u002FHibernate\u002Fcore\u002Ftags\u002Fhibernate-3.5.0-Final\u002Fcore\u002Fsrc\u002Fmain\u002Fjava\u002Forg\u002Fhibernate\u002Fcache\u002Faccess\u002FEntityRegionAccessStrategy.java?r=19148\"\u003EEntityRegionAccessStrategy\u003C\u002Fa\u003E для Entity Region. Эти интерфейсы содержат, в числе прочего, команды для управления блокировками данных в рамках транзакций.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nУ нас уже был раньше кеш для Hibernate, основанный на старом API. Но от него пришлось отказаться, так как старый API не позволял отличить добавление данных в кеш из базы данных от их обновления (так как они устарели). Поэтому первым шагом была реализация нового API, но уже на основе Region \u002F Strategy. Большую помощь оказало то, что Hibernate имеет реализации адаптеров из нового API в старый. Можно просто подсмотреть реализацию, например, EntityRegionAccessStrategy на основе non-transaction cache. Что и было сделано.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОснову API составляет Region:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Ccode\u003E\u003Ca href=\"http:\u002F\u002Fvirtser.net\u002Fblog\u002Fpost\u002Fsource-code-highlighter.aspx\"\u003E\u003C\u002Fa\u003E\u003Cfont color=\"black\"\u003E\u003Col\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#0000ff\"\u003Eabstract\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Eclass\u003C\u002Ffont\u003E SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean {\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#008000\"\u003E\u002F**\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   * Default no-operation implementation of {@link ArpSiteRegionListener}.\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   * Will be replaced by cluster listener if cluster extension is installed\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   * \u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   * @author vlsergey {at} gmail {dot} com\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   *\u002F\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Eprivate\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Estatic\u003C\u002Ffont\u003E final \u003Cfont color=\"#0000ff\"\u003Eclass\u003C\u002Ffont\u003E NoOpListener implements ArpSiteRegionListener {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E onClear() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#008000\"\u003E\u002F\u002F noop\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E    }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E onRemove(Object key) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#008000\"\u003E\u002F\u002F noop\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E    }\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Eprivate\u003C\u002Ffont\u003E AtomicLong clears = \u003Cfont color=\"#0000ff\"\u003Enew\u003C\u002Ffont\u003E AtomicLong(0);\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Eprivate\u003C\u002Ffont\u003E AtomicLong hits = \u003Cfont color=\"#0000ff\"\u003Enew\u003C\u002Ffont\u003E AtomicLong(0);\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Eprotected\u003C\u002Ffont\u003E final AtomicLong lastTimestamp = \u003Cfont color=\"#0000ff\"\u003Enew\u003C\u002Ffont\u003E AtomicLong();\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Eprotected\u003C\u002Ffont\u003E volatile ArpSiteRegionListener listener = \u003Cfont color=\"#0000ff\"\u003Enew\u003C\u002Ffont\u003E NoOpListener();\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Eprivate\u003C\u002Ffont\u003E final Map&lt;Object, Object\u003E map;\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Eprivate\u003C\u002Ffont\u003E AtomicLong miss = \u003Cfont color=\"#0000ff\"\u003Enew\u003C\u002Ffont\u003E AtomicLong(0);\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Eprivate\u003C\u002Ffont\u003E final String regionName;\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#008000\"\u003E\u002F**\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   * @param regionName\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   *      The name of the cache region.\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   * @param useHardReferences\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   *      &lt;code\u003Etrue&lt;\u002Fcode\u003E if cache must use hard references instead of\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   *      {@link java.lang.ref.SoftReference}s. &lt;code\u003Efalse&lt;\u002Fcode\u003E\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   *      otherwise.\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   *\u002F\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  @SuppressWarnings(\u003Cfont color=\"#A31515\"\u003E\"unchecked\"\u003C\u002Ffont\u003E)\u003C\u002Fli\u003E\r\n\u003Cli\u003E  SoftRegion(String regionName, boolean useHardReferences) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.regionName = regionName;\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Eif\u003C\u002Ffont\u003E (useHardReferences) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E      map = \u003Cfont color=\"#0000ff\"\u003Enew\u003C\u002Ffont\u003E ConcurrentHashMap&lt;Object, Object\u003E();\u003C\u002Fli\u003E\r\n\u003Cli\u003E    } \u003Cfont color=\"#0000ff\"\u003Eelse\u003C\u002Ffont\u003E {\u003C\u002Fli\u003E\r\n\u003Cli\u003E      map = Collections\u003C\u002Fli\u003E\r\n\u003Cli\u003E          .&lt;Object, Object\u003E synchronizedMap(\u003Cfont color=\"#0000ff\"\u003Enew\u003C\u002Ffont\u003E ReferenceMap(\u003C\u002Fli\u003E\r\n\u003Cli\u003E              ReferenceMap.SOFT, ReferenceMap.SOFT, \u003Cfont color=\"#0000ff\"\u003Etrue\u003C\u002Ffont\u003E));\u003C\u002Fli\u003E\r\n\u003Cli\u003E    }\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E clear() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    map.clear();\u003C\u002Fli\u003E\r\n\u003Cli\u003E    clears.incrementAndGet();\u003C\u002Fli\u003E\r\n\u003Cli\u003E    listener.onClear();\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E boolean contains(Object key) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    Object value = map.get(key);\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Eif\u003C\u002Ffont\u003E (value != \u003Cfont color=\"#0000ff\"\u003Enull\u003C\u002Ffont\u003E) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#008000\"\u003E\u002F\u002F to let JVM know it shall not GC it because of timeout\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      value.hashCode();\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Etrue\u003C\u002Ffont\u003E;\u003C\u002Fli\u003E\r\n\u003Cli\u003E    }\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Efalse\u003C\u002Ffont\u003E;\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E destroy() throws CacheException {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    map.clear();\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Eprotected\u003C\u002Ffont\u003E Object get(Object key) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    final Object result = map.get(key);\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Eif\u003C\u002Ffont\u003E (result == \u003Cfont color=\"#0000ff\"\u003Enull\u003C\u002Ffont\u003E) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E      miss.incrementAndGet();\u003C\u002Fli\u003E\r\n\u003Cli\u003E    } \u003Cfont color=\"#0000ff\"\u003Eelse\u003C\u002Ffont\u003E {\u003C\u002Fli\u003E\r\n\u003Cli\u003E      hits.incrementAndGet();\u003C\u002Fli\u003E\r\n\u003Cli\u003E    }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E result;\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E getBuildCalls() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E miss.get();\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Eint\u003C\u002Ffont\u003E getCacheSize() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E map.size();\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E getClearCalls() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E clears.get();\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E getElementCountInMemory() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E map.size();\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E getElementCountOnDisk() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E 0;\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E getGetCalls() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E hits.get() + miss.get();\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E getHits() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E hits.get();\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Eint\u003C\u002Ffont\u003E getHitsPercent() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E hits = \u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.hits.get();\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E total = hits + miss.get();\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Eif\u003C\u002Ffont\u003E (total == 0) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E 0;\u003C\u002Fli\u003E\r\n\u003Cli\u003E    }\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E (\u003Cfont color=\"#0000ff\"\u003Eint\u003C\u002Ffont\u003E) (hits * 100 \u002F total);\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E String getName() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E regionName;\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E getSizeInMemory() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E -1;\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Eint\u003C\u002Ffont\u003E getTimeout() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E Timestamper.ONE_MS * 60000; \u003Cfont color=\"#008000\"\u003E\u002F\u002F ie. 60 seconds\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E nextTimestamp() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    final \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E next = Timestamper.next();\u003C\u002Fli\u003E\r\n\u003Cli\u003E    lastTimestamp.set(next);\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E next;\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Eprotected\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E put(Object key, Object value) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    map.put(key, value);\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E remove(Object key) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    map.remove(key);\u003C\u002Fli\u003E\r\n\u003Cli\u003E    listener.onRemove(key);\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E setListener(ArpSiteRegionListener listener) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.listener = listener;\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E Map&lt;?, ?\u003E toMap() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E Collections.unmodifiableMap(map);\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E String toString() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E \u003Cfont color=\"#A31515\"\u003E\"SoftReferenceCache [\"\u003C\u002Ffont\u003E + regionName + \u003Cfont color=\"#A31515\"\u003E\", \"\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E        + \u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.getSizeInMemory() + \u003Cfont color=\"#A31515\"\u003E']'\u003C\u002Ffont\u003E;\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E}\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003C\u002Ffont\u003E\u003Cfont color=\"gray\"\u003E* This source code was highlighted with \u003Cfont color=\"gray\"\u003ESource Code Highlighter\u003C\u002Ffont\u003E.\u003C\u002Ffont\u003E\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nРеализация основных методов довольна тривиальна. Мы реализуем интерфейс \u003Ca href=\"http:\u002F\u002Farpsite.svn.sourceforge.net\u002Fviewvc\u002Farpsite\u002Ftrunk\u002Fmodules\u002Fcore\u002Fhibernate-cache\u002Fsrc\u002Fmain\u002Fjava\u002Fru\u002Farptek\u002Farpsite\u002Fdata\u002Fcache\u002FArpSiteRegion.java?revision=680&amp;view=markup&amp;pathrev=893\"\u003EArpSiteRegion\u003C\u002Fa\u003E, так как он содержит дополнительный метод setListener(), который нам позже понадобится для реализации работы в кластере. Методы nextTimestamp\u002FgetTimeout нам потребуются для TimestampRegionImpl. Дополнительные методы вроде getClearCalls\u002FgetBuildCalls\u002FgetHitsPercent\u002Fclear определены в интерфейсе \u003Ca href=\"http:\u002F\u002Farpsite.svn.sourceforge.net\u002Fviewvc\u002Farpsite\u002Ftrunk\u002Fmodules\u002Fcore\u002Fcommons\u002Fsrc\u002Fmain\u002Fjava\u002Fru\u002Farptek\u002Fcommon\u002FCache.java?revision=332&amp;view=markup\"\u003ECache\u003C\u002Fa\u003E нашего приложения и нужны для управления кешем через \u003Ca href=\"http:\u002F\u002Farpsite.svn.sourceforge.net\u002Fviewvc\u002Farpsite\u002Ftrunk\u002Fmodules\u002Fcore\u002Fcommons\u002Fsrc\u002Fmain\u002Fjava\u002Fru\u002Farptek\u002Fcommon\u002FCacheMBean.java?revision=11&amp;view=markup\"\u003EJMX\u003C\u002Fa\u003E. Hibernate, к сожалению, подобный функционал не предоставляет. Да и откуда он знает про особенности нашего кеша ;)\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"http:\u002F\u002Farpsite.svn.sourceforge.net\u002Fviewvc\u002Farpsite\u002Ftrunk\u002Fmodules\u002Fcore\u002Fhibernate-cache\u002Fsrc\u002Fmain\u002Fjava\u002Fru\u002Farptek\u002Farpsite\u002Fdata\u002Fcache\u002FSoftCollectionRegion.java?revision=819&amp;view=markup\"\u003ESoftCollectionRegion\u003C\u002Fa\u003E и \u003Ca href=\"http:\u002F\u002Farpsite.svn.sourceforge.net\u002Fviewvc\u002Farpsite\u002Ftrunk\u002Fmodules\u002Fcore\u002Fhibernate-cache\u002Fsrc\u002Fmain\u002Fjava\u002Fru\u002Farptek\u002Farpsite\u002Fdata\u002Fcache\u002FSoftEntityRegion.java?revision=819&amp;view=markup\"\u003ESoftEntityRegion\u003C\u002Fa\u003E являются очень похожими, поэтому приведу только второй из них:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Ccode\u003E\u003Ca href=\"http:\u002F\u002Fvirtser.net\u002Fblog\u002Fpost\u002Fsource-code-highlighter.aspx\"\u003E\u003C\u002Fa\u003E\u003Cfont color=\"black\"\u003E\u003Col\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#0000ff\"\u003Eclass\u003C\u002Ffont\u003E SoftEntityRegion extends SoftTransactionalDataRegion implements\u003C\u002Fli\u003E\r\n\u003Cli\u003E    EntityRegion {\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#008000\"\u003E\u002F**\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   * @param regionName\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   *      The name of the cache region.\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   *\u002F\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  SoftEntityRegion(String regionName,\u003C\u002Fli\u003E\r\n\u003Cli\u003E      CacheDataDescription cacheDataDescription) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    super(regionName, cacheDataDescription);\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E EntityRegionAccessStrategy buildAccessStrategy(AccessType accessType) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Enew\u003C\u002Ffont\u003E EntityRegionAccessStrategy() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E boolean afterInsert(Object key, Object value, Object version) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Efalse\u003C\u002Ffont\u003E;\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E boolean afterUpdate(Object key, Object value,\u003C\u002Fli\u003E\r\n\u003Cli\u003E          Object currentVersion, Object previousVersion, SoftLock \u003Cfont color=\"#0000ff\"\u003Elock\u003C\u002Ffont\u003E) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        SoftEntityRegion.\u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.remove(key);\u003C\u002Fli\u003E\r\n\u003Cli\u003E        \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Efalse\u003C\u002Ffont\u003E;\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E evict(Object key) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        SoftEntityRegion.\u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.remove(key);\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E evictAll() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        SoftEntityRegion.\u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.clear();\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E Object get(Object key, \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E txTimestamp) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E SoftEntityRegion.\u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.get(key);\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E EntityRegion getRegion() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E SoftEntityRegion.\u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E;\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E boolean insert(Object key, Object value, Object version) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Efalse\u003C\u002Ffont\u003E;\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E SoftLock lockItem(Object key, Object version) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Enull\u003C\u002Ffont\u003E;\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E SoftLock lockRegion() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Enull\u003C\u002Ffont\u003E;\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E boolean putFromLoad(Object key, Object value,\u003C\u002Fli\u003E\r\n\u003Cli\u003E          \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E txTimestamp, Object version) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        SoftEntityRegion.\u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.put(key, value);\u003C\u002Fli\u003E\r\n\u003Cli\u003E        \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Etrue\u003C\u002Ffont\u003E;\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E boolean putFromLoad(Object key, Object value,\u003C\u002Fli\u003E\r\n\u003Cli\u003E          \u003Cfont color=\"#0000ff\"\u003Elong\u003C\u002Ffont\u003E txTimestamp, Object version, boolean minimalPutOverride) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        \u003Cfont color=\"#0000ff\"\u003Eif\u003C\u002Ffont\u003E (minimalPutOverride &amp;&amp; contains(key)) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E          \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Efalse\u003C\u002Ffont\u003E;\u003C\u002Fli\u003E\r\n\u003Cli\u003E        }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E        SoftEntityRegion.\u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.put(key, value);\u003C\u002Fli\u003E\r\n\u003Cli\u003E        \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Etrue\u003C\u002Ffont\u003E;\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E remove(Object key) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        SoftEntityRegion.\u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.remove(key);\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E removeAll() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        SoftEntityRegion.\u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.clear();\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E unlockItem(Object key, SoftLock \u003Cfont color=\"#0000ff\"\u003Elock\u003C\u002Ffont\u003E) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        SoftEntityRegion.\u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.remove(key);\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E unlockRegion(SoftLock \u003Cfont color=\"#0000ff\"\u003Elock\u003C\u002Ffont\u003E) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        SoftEntityRegion.\u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.clear();\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E boolean update(Object key, Object value,\u003C\u002Fli\u003E\r\n\u003Cli\u003E          Object currentVersion, Object previousVersion) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E        SoftEntityRegion.\u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.remove(key);\u003C\u002Fli\u003E\r\n\u003Cli\u003E        \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Efalse\u003C\u002Ffont\u003E;\u003C\u002Fli\u003E\r\n\u003Cli\u003E      }\u003C\u002Fli\u003E\r\n\u003Cli\u003E    };\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E}\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003C\u002Ffont\u003E\u003Cfont color=\"gray\"\u003E* This source code was highlighted with \u003Cfont color=\"gray\"\u003ESource Code Highlighter\u003C\u002Ffont\u003E.\u003C\u002Ffont\u003E\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОсновная работа выполняется через интерфейс стратегии. Идея использования отдельного интерфейса в том, что в транзакционной реализации каждая транзакция будет использовать отдельный экземпляр EntityRegionAccessStrategy. Однако у нас мы просто перенаправляем все запросы к SoftEntityRegion. Особенности реализации методов update(), unlockItem() и unlockRegion() были подсмотрены у класса EntityAccessStrategyAdapter. С точки зрения будущего «прикручивания» кластера важно отметить, что листенер из SoftRegion будет реагировать только на методы remove() и clear().\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКто их будет вызывать? Сам Hibernate будет их вызывать в те моменты, когда закончит работать с отдельными объектами. Например, он всегда будет вызывать evict(), или же evictAll() — если мы что-то делали с помощью запросов. Именно такая предсказуемая работа с кешем и даст нам возможность в будущем легко добавить поддержку кластера — всего лишь отследив вызовы clear \u002F remove.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nА вот с QueryCache не всё так просто. Проблема в том, что Hibernate… не удаляет старые запросы из кеша. То есть не инвалидирует значения в кеше если что-то произошло. Его поведение хитрее: рядом с QueryResultsRegion трудится TimestampsRegion, который содержит, судя по его названию, timestamp'ы последних изменений отдельных таблиц в базе данных. Поэтому если нам надо выполнить запрос к базе данных, Hibernate делает следующее:\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EВзять timestamp для таблицы из TimestampsRegion\u003C\u002Fli\u003E\r\n\u003Cli\u003EВзять результат из QueryResultsRegion\u003C\u002Fli\u003E\r\n\u003Cli\u003EУ результата взять Timestamp\u003C\u002Fli\u003E\r\n\u003Cli\u003EСравнить с тем, что было взять из TimestampsRegion. Если значение больше — то результат в QueryResultsRegion считается более новым, чем последнее изменение, и его можно использовать.\u003C\u002Fli\u003E\r\n\u003Cli\u003EВажно — если вTimestampsRegion нет значения для определённой таблицы, Hibernate считает, что её данные не менялись\u003C\u002Fli\u003E\r\n\u003Cli\u003EЕсли же timestamp результата меньше, чем взятый из TimestampsRegion, то значение считается устаревшим. Однако, при этом значение не удаляется из кеша, а заменяется тем, что будет получено из базы\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\nПри этом в случае каких-либо запросов на UPDATE или INSERT в TimestampsRegion будет помещён новый timestamp для таблицы, но при этом QueryCache об этом никак оповещён не будет!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИз 5-го пункта, кстати, следует, что для нормальной работы даже без кластера ни в коему случае нельзя использовать SoftReference для хранения значений в TimestampsRegion. Даже в описании UpdateTimestampsCache сказано — \"\u003Ci\u003Ewe recommend that the the underlying cache not be configured for expiry at all\u003C\u002Fi\u003E\" — то есть не удалять значения из этого кеша вообще. Благо, он не очень-то много места занимает в памяти.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИз описания выше ясно, что простой перехват clear()\u002Fremove() ничего не даст — они просто не вызываются. Перехватывать put() у QueryCache бесполезно, да и может оказаться поздно — timestamp мог уже обновиться. Поэтому возможны два варианта:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EДелать полноценную реализацию TimestampsRegion на уровне кластера. А именно — отслеживать выдаваемые на каждой машине timestapm'ы и корректно их синхронизировать на уровне кластера\u003C\u002Fli\u003E\r\n\u003Cli\u003EДелать грязные хаки\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\nК сожалению, первый подход для CMS Arp.Site оказался недопустим — синхронизация Timestamp предполагает некий общий счётчик вроде AtomicLong, но работающий в рамках кластера. То есть все обращения к нему должны быть синхронизированы — каждое добавления объекта в QueryCache кеш. А это очень отрицательно сказалось бы на производительности — синхронная обработка в сети намного дороже, чем асинхронная.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧтобы и здесь реализовать асинхронный подход, мы совершили грязный хак. А именно — мы написали TimestampCache таким образом, что он знает, какие значения Hibernate в него помещает. Это плохо — потому что Hibernate в следующей версии может и поменять тип значений. Поэтому это и называется хаком. Зато работает:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Ccode\u003E\u003Ca href=\"http:\u002F\u002Fvirtser.net\u002Fblog\u002Fpost\u002Fsource-code-highlighter.aspx\"\u003E\u003C\u002Fa\u003E\u003Cfont color=\"black\"\u003E\u003Col\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#0000ff\"\u003Eclass\u003C\u002Ffont\u003E TimestampRegionImpl extends SoftRegion implements ArpSiteTimestampRegion {\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#008000\"\u003E\u002F**\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   * Default no-operation implementation of\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   * {@link ArpSiteTimestampRegionListener}. Will be replaced by cluster\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   * listener if cluster extension is installed\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   * \u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   * @author vlsergey {at} gmail {dot} com\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   *\u002F\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Eprivate\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Estatic\u003C\u002Ffont\u003E final \u003Cfont color=\"#0000ff\"\u003Eclass\u003C\u002Ffont\u003E NoOpListener implements\u003C\u002Fli\u003E\r\n\u003Cli\u003E      ArpSiteTimestampRegionListener {\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E onInvalidate(Serializable space) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#008000\"\u003E\u002F\u002F no op\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E    }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E onPreInvalidate(Serializable space) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E      \u003Cfont color=\"#008000\"\u003E\u002F\u002F no op\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E    }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Eprivate\u003C\u002Ffont\u003E ArpSiteTimestampRegionListener listener = \u003Cfont color=\"#0000ff\"\u003Enew\u003C\u002Ffont\u003E NoOpListener();\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#008000\"\u003E\u002F**\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   * @param regionName\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   *      The name of the region.\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cfont color=\"#008000\"\u003E   *\u002F\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  TimestampRegionImpl(String regionName) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    super(regionName, \u003Cfont color=\"#0000ff\"\u003Etrue\u003C\u002Ffont\u003E);\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E evict(Object key) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    super.remove(key);\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E evictAll() {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    super.clear();\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E Object get(Object key) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ereturn\u003C\u002Ffont\u003E super.get(key);\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E invalidate(Serializable space) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    Long ts = Long.valueOf(nextTimestamp());\u003C\u002Fli\u003E\r\n\u003Cli\u003E    super.put(space, ts);\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E preInvalidate(Serializable space) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    Long ts = Long.valueOf(nextTimestamp() + getTimeout());\u003C\u002Fli\u003E\r\n\u003Cli\u003E    super.put(space, ts);\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E put(Object key, Object value) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    super.put(key, value);\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E    final Serializable space = (Serializable) key;\u003C\u002Fli\u003E\r\n\u003Cli\u003E    final Long timestamp = (Long) value;\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E    final boolean inFuture = timestamp.longValue() \u003E lastTimestamp.get();\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Eif\u003C\u002Ffont\u003E (inFuture) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E      listener.onPreInvalidate(space);\u003C\u002Fli\u003E\r\n\u003Cli\u003E    } \u003Cfont color=\"#0000ff\"\u003Eelse\u003C\u002Ffont\u003E {\u003C\u002Fli\u003E\r\n\u003Cli\u003E      listener.onInvalidate(space);\u003C\u002Fli\u003E\r\n\u003Cli\u003E    }\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E \u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003E@Override\u003C\u002Ffont\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E  \u003Cfont color=\"#0000ff\"\u003Epublic\u003C\u002Ffont\u003E \u003Cfont color=\"#0000ff\"\u003Evoid\u003C\u002Ffont\u003E setTimstampListener(\u003C\u002Fli\u003E\r\n\u003Cli\u003E      ArpSiteTimestampRegionListener timestampListener) {\u003C\u002Fli\u003E\r\n\u003Cli\u003E    \u003Cfont color=\"#0000ff\"\u003Ethis\u003C\u002Ffont\u003E.listener = timestampListener;\u003C\u002Fli\u003E\r\n\u003Cli\u003E  }\u003C\u002Fli\u003E\r\n\u003Cli\u003E}\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003C\u002Ffont\u003E\u003Cfont color=\"gray\"\u003E* This source code was highlighted with \u003Cfont color=\"gray\"\u003ESource Code Highlighter\u003C\u002Ffont\u003E.\u003C\u002Ffont\u003E\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОсновная работа делается в методе put(). Чтобы понять логику метода нужно остановиться на том, что именно делает Hibernate c timestamp cache. А именно делаются три операции:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EОперация get — взять timestamp для region (скрывается за Serializable)\u003C\u002Fli\u003E\r\n\u003Cli\u003EОперация invalidate — взять новый timestamp и поместить его в кеш для region \u003C\u002Fli\u003E\r\n\u003Cli\u003EОперация preinvalidate — взять новый timestamp, прибавить 60 секунд и поместить в кеш\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\nНаша реализация пытается отследить, какое именно из последних двух действий выполняет Hibernate, и, в будущем, распространить данное действие на все узлы кластера. Для этого, разумеется, нам потребуется ещё один Listener (\u003Ca href=\"http:\u002F\u002Farpsite.svn.sourceforge.net\u002Fviewvc\u002Farpsite\u002Ftrunk\u002Fmodules\u002Fcore\u002Fhibernate-cache\u002Fsrc\u002Fmain\u002Fjava\u002Fru\u002Farptek\u002Farpsite\u002Fdata\u002Fcache\u002FArpSiteTimestampRegionListener.java?revision=779&amp;view=markup\"\u003EArpSiteTimestampRegionListener\u003C\u002Fa\u003E). Разницу между invalidate и preinvalidate мы отслеживаем по тому значению, которое помещается в кеш, после чего соответствующим образом уведомляется листенер. А для кластера, для уведомления с других машин, мы сделали свои два метода (доступны через интерфейс \u003Ca href=\"http:\u002F\u002Farpsite.svn.sourceforge.net\u002Fviewvc\u002Farpsite\u002Ftrunk\u002Fmodules\u002Fcore\u002Fhibernate-cache\u002Fsrc\u002Fmain\u002Fjava\u002Fru\u002Farptek\u002Farpsite\u002Fdata\u002Fcache\u002FArpSiteTimestampRegion.java?revision=779&amp;view=markup\"\u003EArpSiteTimestampRegion\u003C\u002Fa\u003E) invalidate и preInvalidate, которые повторяют логику Hibernate. Особенностью реализации является то, что нам не нужно знать текущие значения timestamp на разных машинах для того, чтобы инвалидировать кеши в кластере. Например, метод invalidate(region) возьмёт новый timestamp на \u003Ci\u003Eтекущей\u003C\u002Fi\u003E машине чтобы инвалидировать QueryCache на \u003Ci\u003Eтекущей\u003C\u002Fi\u003E же машине. Ему не интересно, какое было значение на той машине, где Hibernate запрашивал инвалидацию.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСама логика Hibernate, кстати, кому интересно, находится в классе \u003Ca href=\"http:\u002F\u002Ffisheye.jboss.org\u002Fbrowse\u002FHibernate\u002Fcore\u002Ftags\u002Fhibernate-3.5.0-Final\u002Fcore\u002Fsrc\u002Fmain\u002Fjava\u002Forg\u002Fhibernate\u002Fcache\u002FUpdateTimestampsCache.java?r=11588\"\u003EUpdateTimestampsCache\u003C\u002Fa\u003E и \u003Ca href=\"http:\u002F\u002Ffisheye.jboss.org\u002Fbrowse\u002FHibernate\u002Fcore\u002Ftags\u002Fhibernate-3.5.0-Final\u002Fcore\u002Fsrc\u002Fmain\u002Fjava\u002Forg\u002Fhibernate\u002Fcache\u002FStandardQueryCache.java?r=19148\"\u003EStandardQueryCache\u003C\u002Fa\u003E. Если они поменяется, нашу реализацию TimestampRegionImpl, возможно, придётся переписывать. Это та цена, которую мы платим за «хак».\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003EПродолжение следует\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nВ этом топике я описал, как сделана реализация кешей с «зарубками» на то, чтобы можно было связать между собой отдельные кеши на отдельных машинах в единое кластерное решение. Зарубки состоят в следующем:\u003Cbr\u002F\u003E\r\n — классы SoftRegion и TimestampRegionImpl вызывают методы интерфейсов ArpSiteRegionListener и ArpSiteTimestampRegionListener, если нужно уведомить другие машины в кластере о происходящих событиях\u003Cbr\u002F\u003E\r\n — в свою очередь через интерфейсы ArpSiteRegion и ArpSiteTimestampRegion они предоставляют возможность уведомить их о событиях в кластере.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИ хотя работа с кластером пока не описана, кеши уже рабочие.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ следующем топике — как с помощью JGroups теперь сделать кластер.\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"java"},{"titleHtml":"hibernate"},{"titleHtml":"cache"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F91333\u002F1888553357c2ccf0e1fcfebee5624b3e\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F91333\u002F1888553357c2ccf0e1fcfebee5624b3e\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F91333\\\u002F\"},\"headline\":\"SoftReference Read-Write Cache для Hibernate — с «хвостами» для реализации кластера\",\"datePublished\":\"2010-04-26T15:53:10+04:00\",\"dateModified\":\"2010-04-29T00:32:37+04:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Сергей Владимиров\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"В этом топике попробую рассказать о реализации системы кеширования данных в CMS ArpSite. Эта подсистема уже не раз переписывалась, но она является именно тем, чт...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F91333\\\u002F#post-content-body\",\"about\":[\"h_java\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F91333\\\u002F1888553357c2ccf0e1fcfebee5624b3e\\\u002F\"]}","metaDescription":"В этом топике попробую рассказать о реализации системы кеширования данных в CMS ArpSite. Эта подсистема уже не раз переписывалась, но она является именно тем, что позволяет системе вообще работать с...","mainImageUrl":null,"amp":false},"polls":[],"commentsEnabled":true,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false},"572164":{"id":"572164","timePublished":"2021-09-27T11:37:23+00:00","isCorporative":false,"lang":"ru","titleHtml":"Первые шаги в ОТО: прецессия орбиты Меркурия","editorVersion":"2.0","postType":"article","postLabels":[{"type":"tutorial","data":null}],"author":{"id":"1832999","alias":"Yermack","fullname":null,"avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F690\u002F140\u002F823\u002F690140823f555d03574a59d46f648d24.jpg","speciality":"Пользователь"},"statistics":{"commentsCount":15,"favoritesCount":37,"readingCount":5178,"score":21,"votesCount":23},"hubs":[{"relatedData":null,"id":"18840","alias":"julia","type":"collective","title":"Julia","titleHtml":"Julia","isProfiled":true},{"relatedData":null,"id":"21910","alias":"popular_science","type":"collective","title":"Научно-популярное","titleHtml":"Научно-популярное","isProfiled":false},{"relatedData":null,"id":"21968","alias":"physics","type":"collective","title":"Физика","titleHtml":"Физика","isProfiled":false},{"relatedData":null,"id":"22022","alias":"astronomy","type":"collective","title":"Астрономия","titleHtml":"Астрономия","isProfiled":false}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"7","alias":"popsci","title":"Научпоп"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003EКогда речь заходит о теории относительности, частенько на ровном месте разрастаются споры, которые были занесены в почву непонимания и обильно удобрены мифами, недосказанностью и недостаточной математической подготовкой. Даже на лекциях от некоторых профессоров можно услышать, что детище гения Эйнштейна не имеет практической пользы, а на робкие попытки пролепетать что-то про спутниковые системы навигации они пренебрежительно отмахиваются, дескать, там все сложно и двояко. \u003C\u002Fp\u003E\u003Cp\u003EТак что совершенно естественно желание попробовать провести некоторые расчеты самолично, потрогать формулы, покрутить параметры, чтобы постепенно заложить интуицию в столь горячей теме.\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa9f\u002Ff59\u002Fb65\u002Fa9ff59b65da6e8b1e6f59314aadb8e3d.png","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa9f\u002Ff59\u002Fb65\u002Fa9ff59b65da6e8b1e6f59314aadb8e3d.png","fit":"cover","positionY":0,"positionX":0}},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"прецессия"},{"titleHtml":"меркурий"},{"titleHtml":"теория относительности"},{"titleHtml":"уравнения эйнштейна"},{"titleHtml":"метрики"},{"titleHtml":"спасибо scihub"},{"titleHtml":"спасибо mathpix"},{"titleHtml":"астрология_точная_наука"}]},"575686":{"id":"575686","timePublished":"2021-09-28T08:07:48+00:00","isCorporative":true,"lang":"ru","titleHtml":"Когда сделаете доработку?","editorVersion":"2.0","postType":"article","postLabels":[],"author":{"id":"1097452","alias":"Turundur","fullname":"Станислав Малышев","avatarUrl":"","speciality":"Разработчик"},"statistics":{"commentsCount":3,"favoritesCount":18,"readingCount":1630,"score":33,"votesCount":33},"hubs":[{"relatedData":null,"id":"22422","alias":"domclick","type":"corporative","title":"Блог компании ДомКлик","titleHtml":"Блог компании ДомКлик","isProfiled":false},{"relatedData":null,"id":"91","alias":"webdev","type":"collective","title":"Разработка веб-сайтов","titleHtml":"Разработка веб-сайтов","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003EДовольно часто я попадаю в ситуацию, когда мне нужно в моменте оценить длительность реализации реализации бизнес-фичи. Обычно это какая-нибудь рядовая встреча, на которой инициатор бизнес-идеи, резво размахивая руками в воздухе, рассказывает о своем предложении. В конце своего выступления, в котором часто много слов (но не цифр) сказано о том, зачем это фича нужна и какой эффект она даст, всегда звучит сакральный вопрос: «Когда сделаете эту великолепную доработку?»\u003C\u002Fp\u003E\u003Cp\u003EЯ хотел бы поделиться с читателем ходом своих рассуждений, которые позволяют мне довольно точно оценивать сроки реализации даже в самых запущенных случаях.\u003C\u002Fp\u003E\u003Cp\u003EРазумеется, я не смогу предусмотреть и учесть все нюансы и специфики, принятые в различных компаниях в процессе разработки и вывода новой функциональности в эксплуатацию. Однако я верю, что описанные ниже практики будут полезны и вы сможете их адаптировать под свою ситуацию.\u003C\u002Fp\u003E\u003Cp\u003EСразу упомяну, что речь идет в первую очередь о продуктовых компаниях, где нет жесткого учета рабочего времени и можно подумать о качестве и поддерживаемости новой функциональности. В случае заказной разработки всё обычно гораздо сложнее и требует более детальной проработки.\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb36\u002F6f1\u002Fe84\u002Fb366f1e845d886daf41be0f315b7c9a6.png","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb36\u002F6f1\u002Fe84\u002Fb366f1e845d886daf41be0f315b7c9a6.png","fit":"cover","positionY":0,"positionX":0}},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"разработка"},{"titleHtml":"оценка"},{"titleHtml":"заказчик"}]},"579590":{"id":"579590","timePublished":"2021-09-27T23:58:49+00:00","isCorporative":true,"lang":"ru","titleHtml":"Seeed XIAO RP2040: микроконтроллер с отличными возможностями за $5","editorVersion":"1.0","postType":"article","postLabels":[{"type":"translation","data":{"originalAuthorName":"Les Pounder","originalUrl":"https:\u002F\u002Fwww.tomshardware.com\u002Freviews\u002Fseeed-xiao-rp2040-review-dollar5-brain-food"}}],"author":{"id":"2071241","alias":"Deluar","fullname":null,"avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F1a5\u002F707\u002F699\u002F1a5707699dc1770d6a9cdd5d777d5bb0.jpg","speciality":"Разработчик"},"statistics":{"commentsCount":7,"favoritesCount":13,"readingCount":5645,"score":15,"votesCount":21},"hubs":[{"relatedData":null,"id":"14740","alias":"selectel","type":"corporative","title":"Блог компании Selectel","titleHtml":"Блог компании Selectel","isProfiled":false},{"relatedData":null,"id":"19737","alias":"controllers","type":"collective","title":"Программирование микроконтроллеров","titleHtml":"Программирование микроконтроллеров","isProfiled":true},{"relatedData":null,"id":"21894","alias":"gadgets","type":"collective","title":"Гаджеты","titleHtml":"Гаджеты","isProfiled":false},{"relatedData":null,"id":"21976","alias":"DIY","type":"collective","title":"DIY или Сделай сам","titleHtml":"DIY или Сделай сам","isProfiled":false},{"relatedData":null,"id":"22016","alias":"easyelectronics","type":"collective","title":"Электроника для начинающих","titleHtml":"Электроника для начинающих","isProfiled":false}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"7","alias":"popsci","title":"Научпоп"}],"relatedData":null,"leadData":{"textHtml":"\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F53b\u002F390\u002F960\u002F53b39096013cb151e161ebf489fcca96.jpg\" alt=\"image\"\u003E\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nНа первый взгляд Seeed XIAO RP2040 не выглядит многообещающим. Но это обманчивое впечатление. Возможностей у него много. Благо, у компании есть опыт разработки подобных систем, ведь это не первый микроконтроллер от Seeed. Более того, ранее компания выпускала устройство на базе Seeeduino XIAO, которое выглядит близнецом XIAO RP2040, да и стоит столько же — $5.40. \u003Cbr\u003E\r\n\u003Cbr\u003E\r\nНо у XIAO RP2040 другой чип — здесь мы имеем дело с RP2040 SoC, так что этот микроконтроллер гораздо более мощный, чем предыдущая система. Причем доплачивать не нужно — стоимость та же. Стоит ли новинка пяти долларов? Забегая наперед, скажу — да, стоит. \u003Cbr\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"микроконтроллеры"},{"titleHtml":"гаджеты"},{"titleHtml":"устройства"},{"titleHtml":"электроника"}]},"579778":{"id":"579778","timePublished":"2021-09-28T08:51:05+00:00","isCorporative":true,"lang":"ru","titleHtml":"YARL: как Яндекс построил распределённый Rate Limiter с нулевым влиянием на время ответа сервисов","editorVersion":"1.0","postType":"article","postLabels":[],"author":{"id":"91003","alias":"DenKoren","fullname":"Кореневский Денис","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F1a3\u002F2cd\u002F706\u002F1a32cd706b2d50526638707e3d3cdacc.png","speciality":"Release Engineer"},"statistics":{"commentsCount":5,"favoritesCount":8,"readingCount":1167,"score":28,"votesCount":28},"hubs":[{"relatedData":null,"id":"4991","alias":"yandex","type":"corporative","title":"Блог компании Яндекс","titleHtml":"Блог компании Яндекс","isProfiled":false},{"relatedData":null,"id":"4","alias":"hi","type":"collective","title":"Высокая производительность","titleHtml":"Высокая производительность","isProfiled":true},{"relatedData":null,"id":"7504","alias":"refactoring","type":"collective","title":"Проектирование и рефакторинг","titleHtml":"Проектирование и рефакторинг","isProfiled":true},{"relatedData":null,"id":"8880","alias":"server_side_optimization","type":"collective","title":"Серверная оптимизация","titleHtml":"Серверная оптимизация","isProfiled":true},{"relatedData":null,"id":"17350","alias":"s_admin","type":"collective","title":"Серверное администрирование","titleHtml":"Серверное администрирование","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"6","alias":"admin","title":"Администрирование"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003EYandex Rate Limiter (далее просто YARL) — это сервис лимитирования нагрузки для распределённых сервисов. Его особенность в том, что он способен работать с миллионами квот, имея при этом очень низкие накладные расходы на проверку квоты. Если совсем кратко, это система распределённых \u003Ca href=\"https:\u002F\u002Fwww.wikiwand.com\u002Fen\u002FLeaky_bucket\" rel=\"nofollow noopener noreferrer\"\u003ELeaky Bucket'ов\u003C\u002Fa\u003E, с помощью которых можно ограничивать разные величины, связанные со временем: скорость передачи данных по сети, запросы в секунду и т. п.\u003C\u002Fp\u003E\u003Cbr\u003E\r\n\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fdg\u002Fte\u002F--\u002Fdgte--d9wm8qyawhplaw4c87mky.jpeg\"\u003E\u003C\u002Fp\u003E\u003Cbr\u003E\r\n\u003Cp\u003EМеня зовут Денис Кореневский, я работаю в службе разработки внутреннего хранилища Яндекса, и сегодня я расскажу, как YARL устроен внутри, почему мы вообще написали своё решение и с какими трудностями нам пришлось столкнуться в процессе создания. Добро пожаловать под кат.\u003C\u002Fp\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"rate limiter"},{"titleHtml":"балансировка нагрузки"}]},"580124":{"id":"580124","timePublished":"2021-09-27T13:03:14+00:00","isCorporative":true,"lang":"ru","titleHtml":"Электролюминесцентные индикаторы из прошлого","editorVersion":"1.0","postType":"article","postLabels":[],"author":{"id":"146371","alias":"radiolok","fullname":"Артем Кашканов","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Fa46\u002Fc6a\u002F151\u002Fa46c6a15193f7c0cac79d2736b107358.jpg","speciality":"Релейно-декатронный маньяк"},"statistics":{"commentsCount":29,"favoritesCount":43,"readingCount":8793,"score":104,"votesCount":104},"hubs":[{"relatedData":null,"id":"19791","alias":"ruvds","type":"corporative","title":"Блог компании RUVDS.com","titleHtml":"Блог компании RUVDS.com","isProfiled":false},{"relatedData":null,"id":"21484","alias":"electronics","type":"collective","title":"Производство и разработка электроники","titleHtml":"Производство и разработка электроники","isProfiled":true},{"relatedData":null,"id":"21906","alias":"history","type":"collective","title":"История IT","titleHtml":"История IT","isProfiled":false},{"relatedData":null,"id":"21930","alias":"antikvariat","type":"collective","title":"Старое железо","titleHtml":"Старое железо","isProfiled":false}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"7","alias":"popsci","title":"Научпоп"}],"relatedData":null,"leadData":{"textHtml":"Сегодня речь пойдёт об электролюминесцентных индикаторах. Но, не о тех, которые окружают вас повсюду и к которым вы привыкли, а о других — получивших огромную популярность в 60-е годы прошлого века, и так же стремительно канувших в небытие. Заодно запущу свою коллекцию индикаторов, как серийно выпускавшихся, так и уникальных опытных и даже — лабораторных образцов.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\n\u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompany\u002Fruvds\u002Fblog\u002F523004\u002F\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F94e\u002F51f\u002F459\u002F94e51f459ae59c9d2fe6c448cb07bcca.gif\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"Индикатор"},{"titleHtml":"электролюминесцентность"},{"titleHtml":"ruvds_статьи"}]},"580164":{"id":"580164","timePublished":"2021-09-27T11:17:58+00:00","isCorporative":true,"lang":"ru","titleHtml":"Измеряем производительность String.format() в Java","editorVersion":"2.0","postType":"article","postLabels":[{"type":"translation","data":{"originalAuthorName":"@cowtowncoder","originalUrl":"https:\u002F\u002Fcowtowncoder.medium.com\u002Fmeasuring-performance-of-java-string-format-or-lack-thereof-2e1c6a13362c"}}],"author":{"id":"2571061","alias":"GolovinDS","fullname":"Дмитрий Головин","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Fd27\u002Fccd\u002F743\u002Fd27ccd743d8bccbf1a885e5dadaa7ffe.jpg","speciality":"Контент-маркетолог"},"statistics":{"commentsCount":1,"favoritesCount":19,"readingCount":2556,"score":12,"votesCount":14},"hubs":[{"relatedData":null,"id":"21052","alias":"otus","type":"corporative","title":"Блог компании OTUS","titleHtml":"Блог компании OTUS","isProfiled":false},{"relatedData":null,"id":"4","alias":"hi","type":"collective","title":"Высокая производительность","titleHtml":"Высокая производительность","isProfiled":true},{"relatedData":null,"id":"375","alias":"java","type":"collective","title":"Java","titleHtml":"Java","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003EЯ раньше считал, что JDK в целом хорошо оптимизирована, и если в JDK есть простой способ решения какой-то задачи, то он вполне подойдет для большинства ситуаций и будет работать хорошо.\u003C\u002Fp\u003E\u003Cp\u003EНо я обнаружил, что иногда некоторые классы или методы работают на удивление плохо. Знание таких аномалий полезно при работе с требовательным к производительности кодом.\u003C\u002Fp\u003E\u003Cp\u003EВ этом посте рассмотрим один из подобных кейсов: поразительно низкая производительность \u003Ccode\u003EString.format()\u003C\u002Fcode\u003E при простой конкатенации строк.\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fed4\u002F612\u002F7ef\u002Fed46127ef6d1b8f8d650482dfd335220.png","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fed4\u002F612\u002F7ef\u002Fed46127ef6d1b8f8d650482dfd335220.png","fit":"cover","positionY":0,"positionX":0}},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"java"},{"titleHtml":"performance"},{"titleHtml":"jdk"}]},"580170":{"id":"580170","timePublished":"2021-09-28T10:36:25+00:00","isCorporative":true,"lang":"ru","titleHtml":"Дитя конверсии: обзор ноутбука IBM ThinkPad iSeries 1400","editorVersion":"1.0","postType":"article","postLabels":[],"author":{"id":"154372","alias":"ereinion","fullname":"Виталий Прокофьев","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F53d\u002F8ec\u002F1fb\u002F53d8ec1fb1d65d37bb85b94c51b17167.jpg","speciality":"Руководитель отдела услуг администрирования"},"statistics":{"commentsCount":0,"favoritesCount":0,"readingCount":971,"score":11,"votesCount":11},"hubs":[{"relatedData":null,"id":"14740","alias":"selectel","type":"corporative","title":"Блог компании Selectel","titleHtml":"Блог компании Selectel","isProfiled":false},{"relatedData":null,"id":"21898","alias":"hardware","type":"collective","title":"Компьютерное железо","titleHtml":"Компьютерное железо","isProfiled":false},{"relatedData":null,"id":"21906","alias":"history","type":"collective","title":"История IT","titleHtml":"История IT","isProfiled":false},{"relatedData":null,"id":"21930","alias":"antikvariat","type":"collective","title":"Старое железо","titleHtml":"Старое железо","isProfiled":false},{"relatedData":null,"id":"21952","alias":"notebooks","type":"collective","title":"Ноутбуки","titleHtml":"Ноутбуки","isProfiled":false}],"flows":[{"id":"7","alias":"popsci","title":"Научпоп"}],"relatedData":null,"leadData":{"textHtml":"\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fsn\u002Fs4\u002F4f\u002Fsns44fybis21deyqyx_mrkwrkie.png\"\u003E\u003C\u002Fdiv\u003E\u003Cbr\u003E\r\nКогда компания пытается войти в новый для себя сегмент рынка, часто получаются очень необычные и забавные девайсы. Яркие примеры — почти электромобиль BMW i3, самолет HondaJet, постсоветские мясорубки и соковыжималки, которые после обработки напильником требовали лицензии на ношение, и ноутбуки IBM ThinkPad iSeries. \u003Cbr\u003E\r\n\u003Cbr\u003E\r\nЗадуманные как недорогие машины для домашнего применения и крайне малого бизнеса, эти машины стали примером неоднозначных решений и странного дизайна. Но со временем превратились в большую редкость, не сразу понятую и принятую коллекционерами, но теперь — очень желанную.\u003Cbr\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"ноутбук"},{"titleHtml":"лэптоп"},{"titleHtml":"старое железо"},{"titleHtml":"история ИТ"},{"titleHtml":"celeron"},{"titleHtml":"intel"},{"titleHtml":"thinkpad"},{"titleHtml":"ibm"},{"titleHtml":"lenovo"}]},"580172":{"id":"580172","timePublished":"2021-09-27T11:45:49+00:00","isCorporative":true,"lang":"ru","titleHtml":"Небинарный ngIf*","editorVersion":"2.0","postType":"article","postLabels":[],"author":{"id":"1050218","alias":"Waterplea","fullname":"Александр Инкин","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Fa70\u002F569\u002Ff31\u002Fa70569f31346559ce2b8b875e7f97480.jpg","speciality":"Google Developer Expert | Angular"},"statistics":{"commentsCount":2,"favoritesCount":21,"readingCount":1383,"score":18,"votesCount":20},"hubs":[{"relatedData":null,"id":"17420","alias":"tinkoff","type":"corporative","title":"Блог компании TINKOFF","titleHtml":"Блог компании TINKOFF","isProfiled":false},{"relatedData":null,"id":"91","alias":"webdev","type":"collective","title":"Разработка веб-сайтов","titleHtml":"Разработка веб-сайтов","isProfiled":true},{"relatedData":null,"id":"18109","alias":"angular","type":"collective","title":"Angular","titleHtml":"Angular","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003EВам когда-нибудь хотелось отобразить состояние загрузки, пока \u003Ccode\u003EngIf\u003C\u002Fcode\u003E ждет ответа от \u003Ccode\u003Easync\u003C\u002Fcode\u003E-пайпа? Или, может, вы мечтали передать в \u003Ccode\u003EngFor\u003C\u002Fcode\u003E шаблон для пустого массива? Возможно, вы бросили это, потому что вам не хотелось реализовывать базовую логику этих директив самому. На самом деле в этом нет нужды! Один и тот же селектор может подцепить несколько директив, что позволяет расширить функциональность встроенных директив дополнительной логикой.\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F846\u002F786\u002F3e2\u002F8467863e2df65db32cb31f4b16c822ef.png","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F846\u002F786\u002F3e2\u002F8467863e2df65db32cb31f4b16c822ef.png","fit":"cover","positionY":0,"positionX":0}},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"template"},{"titleHtml":"directive"},{"titleHtml":"angular"},{"titleHtml":"structural"}]},"580194":{"id":"580194","timePublished":"2021-09-27T12:36:12+00:00","isCorporative":true,"lang":"ru","titleHtml":"Сотрудники на карте: отвечаем на 10 важных вопросов о трекинге","editorVersion":"2.0","postType":"article","postLabels":[],"author":{"id":"1254716","alias":"Axelus","fullname":null,"avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F118\u002Fc4f\u002F08f\u002F118c4f08ffa66438ad6be22e205d563d.png","speciality":"Разработчик"},"statistics":{"commentsCount":0,"favoritesCount":13,"readingCount":1738,"score":13,"votesCount":15},"hubs":[{"relatedData":null,"id":"20758","alias":"regionsoft","type":"corporative","title":"Блог компании RegionSoft","titleHtml":"Блог компании RegionSoft","isProfiled":false},{"relatedData":null,"id":"6398","alias":"it-infrastructure","type":"collective","title":"IT-инфраструктура","titleHtml":"IT-инфраструктура","isProfiled":true},{"relatedData":null,"id":"12365","alias":"saas","type":"collective","title":"SaaS \u002F S+S","titleHtml":"SaaS \u002F S+S","isProfiled":true},{"relatedData":null,"id":"17783","alias":"geo","type":"collective","title":"Геоинформационные сервисы","titleHtml":"Геоинформационные сервисы","isProfiled":true},{"relatedData":null,"id":"20736","alias":"hr_management","type":"collective","title":"Управление персоналом","titleHtml":"Управление персоналом","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"3","alias":"management","title":"Менеджмент"},{"id":"6","alias":"admin","title":"Администрирование"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003EЛюбой контроль сотрудников — опасный и болезненный вопрос, особенно в небольших компаниях. Часто в дружеские и открытые отношения компании не вписывается ни одна из форм контроля, рассчитывать можно только на доверие. Но пресловутый ковид и здесь внёс свои коррективы: расширение удалённой работы, увеличение штата мобильных сотрудников, частичная занятость пополнили ряды полевых сисадминов, аутсорсеров поддержки и остальных «разъездных» работников. Увы, люди разные и вслед за приятными плодами и бонусами удалёнки пришли негативные истории про поведение курьеров, опоздания и откровенные нарушения сотрудников на территории клиентов, неявки на работу или к заказчику и т.д. С этим столкнулись и ритейл, и ИТ, и любая сфера с мобильными сотрудниками. Очень хочется верить в лучшее, но без минимального контроля можно просто потерять бизнес — и тогда пострадают коллеги нерадивых сотрудников.\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe4a\u002F5b9\u002Fa9d\u002Fe4a5b9a9d62c342fa897f4531ec9301b.png","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe4a\u002F5b9\u002Fa9d\u002Fe4a5b9a9d62c342fa897f4531ec9301b.png","fit":"cover","positionY":0,"positionX":0}},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"geomonitor"},{"titleHtml":"геолокация"},{"titleHtml":"геозона"},{"titleHtml":"трекинг"}]},"580204":{"id":"580204","timePublished":"2021-09-27T12:31:54+00:00","isCorporative":false,"lang":"ru","titleHtml":"Почему с using namespace std; может быть очень плохо","editorVersion":"2.0","postType":"article","postLabels":[{"type":"translation","data":{"originalAuthorName":"sbi, Greg Hewgill","originalUrl":"https:\u002F\u002Fstackoverflow.com\u002Fquestions\u002F1452721\u002Fwhy-is-using-namespace-std-considered-bad-practice"}}],"author":{"id":"936030","alias":"F0iL","fullname":"K. just K.","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Fbcd\u002F9c7\u002F270\u002Fbcd9c7270c0727e164ac404a7f929971.jpg","speciality":"Разработчик"},"statistics":{"commentsCount":24,"favoritesCount":19,"readingCount":10751,"score":23,"votesCount":33},"hubs":[{"relatedData":null,"id":"359","alias":"programming","type":"collective","title":"Программирование","titleHtml":"Программирование","isProfiled":true},{"relatedData":null,"id":"524","alias":"complete_code","type":"collective","title":"Совершенный код","titleHtml":"Совершенный код","isProfiled":true},{"relatedData":null,"id":"559","alias":"cpp","type":"collective","title":"C++","titleHtml":"C++","isProfiled":true},{"relatedData":null,"id":"17188","alias":"compilers","type":"collective","title":"Компиляторы","titleHtml":"Компиляторы","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003EТо, что написано ниже, для многих квалифицированных C++ разработчиков будет прекрасно известной и очевидной вещью, но тем не менее, я периодически встречаю using namespace std; в коде различных проектов, а недавно в \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F579998\" rel=\"noopener noreferrer nofollow\"\u003Eнашумевшей статье про впечатления от высшего образования\u003C\u002Fa\u003E было упомянуто, что студентов так учат писать код в вузах, поэтому давайте повторим очевидное еще раз.\u003C\u002Fp\u003E\u003Cp\u003EИтак... многие слышали, что \u003Cstrong\u003Eusing namespace std;\u003C\u002Fstrong\u003E в C++ считается плохой практикой. Касательно недопустимости использования using namespace в header-файлах вопросов обычно не возникает, если мы хоть немного понимаем, как работает препроцессор компилятора: .hpp-файлы при использовании директивы #include вставляются в код \"как есть\", и соответственно using автоматически распространится на все затронутые  .hpp- и .cpp-файлы, если файл с ним был заинклюден хоть в одном звене цепочки (на одном из сайтов это метко обозвали как \"заболевание, передающеемя половым путем\"). Но вот про .cpp-файлы все не так очевидно, так что давайте еще раз разберем, что же именно здесь не так.\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F662\u002F8a9\u002Fe33\u002F6628a9e3322ab1dbca4e4976098da83d.jpg","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F662\u002F8a9\u002Fe33\u002F6628a9e3322ab1dbca4e4976098da83d.jpg","fit":"cover","positionY":0,"positionX":0}},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"с++"},{"titleHtml":"namespace"},{"titleHtml":"namespaces"},{"titleHtml":"best practices"},{"titleHtml":"антипаттерны"}]},"580206":{"id":"580206","timePublished":"2021-09-27T12:51:03+00:00","isCorporative":false,"lang":"ru","titleHtml":"МТС отказался от скрытых мобильных подписок?","editorVersion":"2.0","postType":"article","postLabels":[],"author":{"id":"2467147","alias":"Plusodin","fullname":"Владимир","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F343\u002Fb77\u002Fd12\u002F343b77d12f047368849a9880276f936e.jpg","speciality":"Пользователь"},"statistics":{"commentsCount":39,"favoritesCount":9,"readingCount":8494,"score":21,"votesCount":23},"hubs":[{"relatedData":null,"id":"22008","alias":"cellular","type":"collective","title":"Сотовая связь","titleHtml":"Сотовая связь","isProfiled":false}],"flows":[{"id":"7","alias":"popsci","title":"Научпоп"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003EПривет, Хабр!\u003C\u002Fp\u003E\u003Cp\u003EНу что, подходит к концу первый сезон сериала «О скрытых мобильных подписках и операторах связи». Предыдущие три серии: \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F550448\u002F\" rel=\"noopener noreferrer nofollow\"\u003EМегафон\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F563260\u002F\" rel=\"noopener noreferrer nofollow\"\u003EБилайн\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F571256\u002F\" rel=\"noopener noreferrer nofollow\"\u003ETele2\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cp\u003EНу и вишенка на этом торте – МТС.\u003C\u002Fp\u003E","imageUrl":null,"buttonTextHtml":"Читать далее","image":null},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"мтс"},{"titleHtml":"мобильные подписки"},{"titleHtml":"подписки"},{"titleHtml":"оператор связи"},{"titleHtml":"теле2"},{"titleHtml":"мегафон"},{"titleHtml":"билайн"}]},"580210":{"id":"580210","timePublished":"2021-09-27T12:53:02+00:00","isCorporative":false,"lang":"ru","titleHtml":"PHP Дайджест № 212 (13 – 27 сентября 2021)","editorVersion":"1.0","postType":"article","postLabels":[],"author":{"id":"100489","alias":"pronskiy","fullname":"Роман Пронский","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F27f\u002Fb99\u002Feb3\u002F27fb99eb3e30e3221c5839e88be02395.jpg","speciality":"PHP"},"statistics":{"commentsCount":1,"favoritesCount":16,"readingCount":5636,"score":54,"votesCount":54},"hubs":[{"relatedData":null,"id":"91","alias":"webdev","type":"collective","title":"Разработка веб-сайтов","titleHtml":"Разработка веб-сайтов","isProfiled":true},{"relatedData":null,"id":"260","alias":"php","type":"collective","title":"PHP","titleHtml":"PHP","isProfiled":true},{"relatedData":null,"id":"477","alias":"symfony","type":"collective","title":"Symfony","titleHtml":"Symfony","isProfiled":true},{"relatedData":null,"id":"9554","alias":"yii","type":"collective","title":"Yii","titleHtml":"Yii","isProfiled":true},{"relatedData":null,"id":"18812","alias":"laravel","type":"collective","title":"Laravel","titleHtml":"Laravel","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"leadData":{"textHtml":"\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fek\u002F6r\u002Fr1\u002Fek6rr1odvyzb89tfv0lq4cmfxi4.jpeg\"\u003E\u003C\u002Fdiv\u003E\u003Cbr\u003E\r\nПодборка свежих новостей и материалов из мира PHP.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nВышел PHP 8.1 RC2 и уже доступен первый пакет с использованием перечислений, будет сделан форк Magento, новый тип стандартов PER в дополнение к PSR, стартовала PhpStorm 2021.3 EAP, Symfony 6 будет полностью типизирован — как обновляться?\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nДля PHP 8.2 предложены новые оптимизированные структуры данных.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nТакже в выпуске порция инструментов, полезные статьи, видео и анонсы двух митапов.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nПриятного чтения!\u003Cbr\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"дайджест"},{"titleHtml":"php-дайджест"},{"titleHtml":"PHP"},{"titleHtml":"Symfony"},{"titleHtml":"Laravel"},{"titleHtml":"Magento"},{"titleHtml":"PHPUnit"},{"titleHtml":"PHP 8.1"},{"titleHtml":"PHP 8.2"}]},"580214":{"id":"580214","timePublished":"2021-09-28T03:06:01+00:00","isCorporative":false,"lang":"ru","titleHtml":"Как выбрать подложку для СВЧ плат?","editorVersion":"2.0","postType":"article","postLabels":[],"author":{"id":"2759195","alias":"Leka_engineer","fullname":"Олеся","avatarUrl":"","speciality":"инженер-разработчик СВЧ устройств"},"statistics":{"commentsCount":12,"favoritesCount":12,"readingCount":969,"score":14,"votesCount":18},"hubs":[{"relatedData":null,"id":"19395","alias":"netdev","type":"collective","title":"Разработка систем связи","titleHtml":"Разработка систем связи","isProfiled":true},{"relatedData":null,"id":"21484","alias":"electronics","type":"collective","title":"Производство и разработка электроники","titleHtml":"Производство и разработка электроники","isProfiled":true},{"relatedData":null,"id":"22016","alias":"easyelectronics","type":"collective","title":"Электроника для начинающих","titleHtml":"Электроника для начинающих","isProfiled":false}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"7","alias":"popsci","title":"Научпоп"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003EЭтой статьёй я продолжаю цикл (надеюсь, что получится несколько) статей про особенности проектирования и изготовления СВЧ-плат. Эта  статья очень простая, так что, скорее всего, большинство читателей-СВЧшников не найдёт в ней ничего нового. Однако, я надеюсь, что статья будет полезна начинающим разработчикам.\u003C\u002Fp\u003E","imageUrl":null,"buttonTextHtml":"далее","image":null},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"свч"},{"titleHtml":"свч-техника"},{"titleHtml":"печатная плата"},{"titleHtml":"производство электроники"},{"titleHtml":"разработка электроники"},{"titleHtml":"приложения для android"}]},"580228":{"id":"580228","timePublished":"2021-09-27T16:41:21+00:00","isCorporative":true,"lang":"ru","titleHtml":"Идеальная светодиодная лампа за 21 рубль","editorVersion":"1.0","postType":"article","postLabels":[],"author":{"id":"108988","alias":"AlexeyNadezhin","fullname":"Алексей Надежин","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Ffdc\u002F3ac\u002F9a2\u002Ffdc3ac9a2dc0107cc956f1bd0cf5fc2b.jpg","speciality":"Блогер"},"statistics":{"commentsCount":61,"favoritesCount":114,"readingCount":29781,"score":150,"votesCount":154},"hubs":[{"relatedData":null,"id":"21646","alias":"lamptest","type":"corporative","title":"Блог компании LampTest","titleHtml":"Блог компании LampTest","isProfiled":false},{"relatedData":null,"id":"21894","alias":"gadgets","type":"collective","title":"Гаджеты","titleHtml":"Гаджеты","isProfiled":false}],"flows":[{"id":"7","alias":"popsci","title":"Научпоп"}],"relatedData":null,"leadData":{"textHtml":"Удивительно осознавать, что достаточно сложное электронное устройство, которым является светодиодная лампочка, может стоить 21 рубль. \u003Cbr\u003E\r\n\u003Cbr\u003E\r\nЕщё сложнее поверить, что эта лампочка безукоризненна по всем параметрам.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\n\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F20f\u002F849\u002Ffcd\u002F20f849fcd6a3891f506676fc87223bdf.jpg\"\u003E\u003C\u002Fdiv\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"led"},{"titleHtml":"светодиодные лампы"},{"titleHtml":"тест"}]},"580270":{"id":"580270","timePublished":"2021-09-28T07:08:30+00:00","isCorporative":true,"lang":"ru","titleHtml":"Варим суп из стали: оптимизация логистики ковшей и как устроен цех КЦ № 2","editorVersion":"1.0","postType":"article","postLabels":[],"author":{"id":"2790193","alias":"AlexanderSkorniakov","fullname":"Александр Скорняков","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Fcbf\u002F737\u002F072\u002Fcbf737072762c9fe82994575e36e0c25.jpg","speciality":"Руководитель цифровых продуктов"},"statistics":{"commentsCount":14,"favoritesCount":14,"readingCount":2167,"score":39,"votesCount":39},"hubs":[{"relatedData":null,"id":"22816","alias":"nlmk","type":"corporative","title":"Блог компании Блог компании Группа НЛМК","titleHtml":"Блог компании Блог компании Группа НЛМК","isProfiled":false},{"relatedData":null,"id":"397","alias":"analysis_design","type":"collective","title":"Анализ и проектирование систем","titleHtml":"Анализ и проектирование систем","isProfiled":true},{"relatedData":null,"id":"18816","alias":"industrial_control_system","type":"collective","title":"Промышленное программирование","titleHtml":"Промышленное программирование","isProfiled":true},{"relatedData":null,"id":"20682","alias":"pm","type":"collective","title":"Управление проектами","titleHtml":"Управление проектами","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"3","alias":"management","title":"Менеджмент"}],"relatedData":null,"leadData":{"textHtml":"Привет из конвертерного цеха металлургического комбината! Смотрите, у нас тут есть вот такой суп в ковше, стоящем на сталевозе:\u003Cbr\u003E\r\n\u003Cbr\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fdh\u002F3m\u002Fmn\u002Fdh3mmn_3v_fbdyt4k2hs3fhfnjm.jpeg\" alt=\"image\"\u003E\u003Cbr\u003E\r\n\u003Ci\u003EТаких ковшей на 320 тонн стали в цехе 40 штук, и они медленно остывают. Этой стали грустно и одиноко, она подмерзает. Через эти ковши проходит 10 миллионов тонн стали в год, это 14% стали России\u003C\u002Fi\u003E\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nНа входе в цех у нас жидкий чугун и металлолом, на выходе надо получить сляб — большой слиток стали. Контур системы диспетчеризации «Гефест» начинается с конвертера, где мы продуваем чугун кислородом, таким образом окисляем и удаляем ненужные нам примеси. После конвертера получается «стальной бульон» для супа, в который уже можно добавлять основные ингредиенты, чтобы получались разные марки стали. За смену мы выплавляем несколько заказов, и каждая сталь требует своего рецепта — это разные добавки, разные техпроцессы, разные температуры и разные последовательности действий. \u003Cbr\u003E\r\n\u003Cbr\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fiv\u002Fmh\u002Fdj\u002Fivmhdjdffezd6k7p1kmw38_akcu.jpeg\" alt=\"image\"\u003E\u003Cbr\u003E\r\n\u003Ci\u003EНа участке аргонной установки\u003C\u002Fi\u003E\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nУзким местом, в зависимости от сорта стали, может стать любой технологический узел на пути плавки от конвертера до разливки — агрегаты внепечной обработки, мостовые краны или сталевозы для перемещения ковшей могут оказаться в какой-то конкретный момент перегружены. Раньше графики последовательности действий составлялись в блокноте человеком и были недостаточно оптимизированы. Плюс непредсказуемость: графики с довольно широкими временными границами дают большие потери производительности, а графики с узкими границами — не дают прореагировать на возможную поломку, задержку в процессе или вынужденную остановку. Не знаю, сколько стоит у вас простой прода, но у нас один остывший не к месту ковш запросто может нанести ущерба на несколько миллионов рублей. \u003Cbr\u003E\r\n\u003Cbr\u003E\r\nВ общем, мы написали систему, которая не только оптимизирует загрузку этого участка производства, но и регулярно (во время смены) пересчитывает всю логистику ковшей.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nНо давайте начну с, собственно, рассказа про то, что же именно оптимизируется в цехе.","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"сталь"},{"titleHtml":"производство"},{"titleHtml":"оптимизация"},{"titleHtml":"металл"},{"titleHtml":"металлургия"},{"titleHtml":"диспетчеризация"}]},"580304":{"id":"580304","timePublished":"2021-09-27T18:31:25+00:00","isCorporative":true,"lang":"ru","titleHtml":"Как сделать 248MP фотографию Солнца","editorVersion":"1.0","postType":"article","postLabels":[{"type":"translation","data":{"originalAuthorName":"Simon Tang","originalUrl":"https:\u002F\u002Fpetapixel.com\u002F2021\u002F09\u002F15\u002Fa-closer-look-how-i-created-a-248mp-photo-of-the-sun\u002F"}}],"author":{"id":"2192534","alias":"Itelma","fullname":"T-800","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Fc3a\u002Fd1e\u002F43d\u002Fc3ad1e43d500046c3228c9494b510912.jpg","speciality":"Пользователь"},"statistics":{"commentsCount":10,"favoritesCount":11,"readingCount":3407,"score":15,"votesCount":15},"hubs":[{"relatedData":null,"id":"22356","alias":"itelma","type":"corporative","title":"Блог компании НПП ИТЭЛМА","titleHtml":"Блог компании НПП ИТЭЛМА","isProfiled":false},{"relatedData":null,"id":"17175","alias":"image_processing","type":"collective","title":"Обработка изображений","titleHtml":"Обработка изображений","isProfiled":true},{"relatedData":null,"id":"21910","alias":"popular_science","type":"collective","title":"Научно-популярное","titleHtml":"Научно-популярное","isProfiled":false},{"relatedData":null,"id":"21932","alias":"photo","type":"collective","title":"Фототехника","titleHtml":"Фототехника","isProfiled":false},{"relatedData":null,"id":"22022","alias":"astronomy","type":"collective","title":"Астрономия","titleHtml":"Астрономия","isProfiled":false}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"7","alias":"popsci","title":"Научпоп"}],"relatedData":null,"leadData":{"textHtml":"\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fe02\u002F643\u002Fa55\u002Fe02643a550e20aa10c366e20956e4b40.jpg\" alt=\"image\"\u003E\u003Cbr\u003E\r\n\u003Cbr\u003E\r\n\u003Ci\u003EЭто изображение диска нашего Солнца создано с помощью большого рефракторного (линзового) телескопа и высокоскоростной монохромной CMOS-камеры.\u003C\u002Fi\u003E\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nКаждый день над нашими головами висит большой шар света. Он там всегда, и никто не обращает на него внимания. Разумеется, мы не советуем вам долго смотреть на него и при этом ослепнуть, тем не менее, наука дала нам возможность смотреть прямо на солнце совершенно безопасно.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nПоскольку техника стала более доступной, обычный человек может заглянуть в многочисленные слои Солнца с помощью специального оборудования, которое может купить в любом хорошем магазине телескопов.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nВ этой статье мы подробно рассмотрим слой, известный как хромосфера: область Солнца, видимая в оранжево-красном спектре. При помощи специального фильтра это устройство блокирует весь нежелательный свет, пропуская при этом определенный диапазон частот, который нас интересует.\u003Cbr\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"обработка изображений"},{"titleHtml":"фототехника"}]},"580336":{"id":"580336","timePublished":"2021-09-28T05:40:43+00:00","isCorporative":false,"lang":"ru","titleHtml":"DOM, который построил Chrome. Или не построил? Или не Chrome? Или не DOM?","editorVersion":"2.0","postType":"article","postLabels":[],"author":{"id":"2671923","alias":"Maxim_from_HW","fullname":"Максим","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F33e\u002F1a0\u002F5ba\u002F33e1a05ba0d2d651cc292ce76ad45ee1.png","speciality":"CEO"},"statistics":{"commentsCount":18,"favoritesCount":37,"readingCount":2895,"score":17,"votesCount":17},"hubs":[{"relatedData":null,"id":"91","alias":"webdev","type":"collective","title":"Разработка веб-сайтов","titleHtml":"Разработка веб-сайтов","isProfiled":true},{"relatedData":null,"id":"357","alias":"javascript","type":"collective","title":"JavaScript","titleHtml":"JavaScript","isProfiled":true},{"relatedData":null,"id":"359","alias":"programming","type":"collective","title":"Программирование","titleHtml":"Программирование","isProfiled":true},{"relatedData":null,"id":"524","alias":"complete_code","type":"collective","title":"Совершенный код","titleHtml":"Совершенный код","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003EОбычный, теневой, виртуальный, инкрементальный… Как получилось, что простой программный интерфейс доступа к элементам веб-страниц обзавелся таким количеством «родственников»? Чем современные фреймворки не устраивает стандартная объектная модель документа или просто DOM? Что и как на самом деле отрисовывает браузер в процессе рендера веб-страницы?\u003C\u002Fp\u003E\u003Cp\u003EВсем привет, это \u003Ca href=\"https:\u002F\u002Fwww.facebook.com\u002Fmy.kravets\" rel=\"noopener noreferrer nofollow\"\u003EМакс Кравец\u003C\u002Fa\u003E из Holyweb. Помните сцену из Матрицы, в которой один из юных кандидатов в Избранные наставляет Нео: «Не пытайся согнуть ложку. Первое, что ты должен понять — ложки не существует!»? Давайте переформулирую: «Не пытайся изменить DOM...». А вот о том, что прячется под многоточием, мы сегодня и поговорим.\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F5c9\u002F1cb\u002Fe9b\u002F5c91cbe9b4674ea479fed0a55f81fb7c.png","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F5c9\u002F1cb\u002Fe9b\u002F5c91cbe9b4674ea479fed0a55f81fb7c.png","fit":"cover","positionY":0,"positionX":0}},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"dom"},{"titleHtml":"google chrome"},{"titleHtml":"javascript"},{"titleHtml":"css"}]},"580348":{"id":"580348","timePublished":"2021-09-28T08:18:27+00:00","isCorporative":true,"lang":"ru","titleHtml":"Самый большой космический телескоп Джеймс Уэбб должен изменить наши представления о космосе","editorVersion":"2.0","postType":"article","postLabels":[],"author":{"id":"64252","alias":"Cloud4Y","fullname":"Cloud4Y","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Fc2d\u002Fd0d\u002Fc05\u002Fc2dd0dc05834aebeb86bb76e35caeaab.png","speciality":"Корпоративный облачный провайдер"},"statistics":{"commentsCount":10,"favoritesCount":4,"readingCount":1797,"score":16,"votesCount":18},"hubs":[{"relatedData":null,"id":"17352","alias":"cloud4y","type":"corporative","title":"Блог компании Cloud4Y","titleHtml":"Блог компании Cloud4Y","isProfiled":false},{"relatedData":null,"id":"21910","alias":"popular_science","type":"collective","title":"Научно-популярное","titleHtml":"Научно-популярное","isProfiled":false},{"relatedData":null,"id":"21962","alias":"space","type":"collective","title":"Космонавтика","titleHtml":"Космонавтика","isProfiled":false}],"flows":[{"id":"7","alias":"popsci","title":"Научпоп"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003EИзучение новых миров,  понимание происхождения Вселенной, поиск жизни вне Земли. Всё это — задачи космического телескопа \"Джеймс Уэбб\", долгожданного преемника Хаббла.  Телескоп больше и легче Хаббла, зато в 100 раз мощнее,  а приборы — в семь раз чувствительнее. \u003C\u002Fp\u003E\u003Cp\u003EДжеймс Уэбб — это устройство для поиска ответов на неотвеченные вопросы о Вселенной, для изучения того, что до сих пор оставалось неизведанным. Что же такого в этом телескопе?\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F0ed\u002F24e\u002Fd75\u002F0ed24ed759f6e945b81c1ce1beedd228.jpg","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F0ed\u002F24e\u002Fd75\u002F0ed24ed759f6e945b81c1ce1beedd228.jpg","fit":"cover","positionY":0,"positionX":0}},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"Телескоп"},{"titleHtml":"уэбб"},{"titleHtml":"космос"},{"titleHtml":"технологии"}]},"580360":{"id":"580360","timePublished":"2021-09-28T07:27:40+00:00","isCorporative":true,"lang":"ru","titleHtml":"Вы используете больше Open Source-софта, чем думаете","editorVersion":"2.0","postType":"article","postLabels":[{"type":"translation","data":{"originalAuthorName":"Klint Finley","originalUrl":"https:\u002F\u002Fgithub.com\u002Freadme\u002Ffeatured\u002Funseen-oss"}}],"author":{"id":"16172","alias":"shurup","fullname":"Дмитрий Шурупов","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F062\u002Fc85\u002F607\u002F062c85607fbe4aaa29e1ad2076cd13a0.jpg","speciality":"Open Source geek"},"statistics":{"commentsCount":1,"favoritesCount":2,"readingCount":1691,"score":24,"votesCount":28},"hubs":[{"relatedData":null,"id":"20940","alias":"flant","type":"corporative","title":"Блог компании Флант","titleHtml":"Блог компании Флант","isProfiled":false},{"relatedData":null,"id":"50","alias":"infosecurity","type":"collective","title":"Информационная безопасность","titleHtml":"Информационная безопасность","isProfiled":true},{"relatedData":null,"id":"144","alias":"open_source","type":"collective","title":"Open source","titleHtml":"Open source","isProfiled":true},{"relatedData":null,"id":"20688","alias":"research","type":"collective","title":"Исследования и прогнозы в IT","titleHtml":"Исследования и прогнозы в IT","isProfiled":false}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"3","alias":"management","title":"Менеджмент"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003E\u003Cstrong\u003E\u003Cem\u003EПрим. перев.\u003C\u002Fem\u003E\u003C\u002Fstrong\u003E\u003Cem\u003E: оригинал этой статьи был опубликован минувшим летом в рамках проекта ReadME. Он создан в GitHub с целью стать своеобразной трибуной для многочисленных Open Source-разработчиков, предоставив им возможность поделиться с широким сообществом актуальными для них проблемами. Данный материал несет в себе призыв «перестать воспринимать Open Source как должное» и раскрывает те сложности, с которыми сталкиваются многие авторы свободного ПО, применяемого буквально повсеместно.\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003Cp\u003EТобиас Копперс (Tobias Koppers) не работает в Instagram. И никогда не работал. Но с 2014 года он отвечает за поддержку важного компонента веб-версии Instagram. Копперс является создателем webpack — Open Source-инструмента для сборки (или «бандлинга») кода JavaScript.\u003C\u002Fp\u003E","imageUrl":null,"buttonTextHtml":"Читать далее","image":null},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"open source"}]},"580374":{"id":"580374","timePublished":"2021-09-28T08:46:26+00:00","isCorporative":true,"lang":"ru","titleHtml":"Делаем базу знаний для .NET разработчиков","editorVersion":"2.0","postType":"article","postLabels":[],"author":{"id":"1181772","alias":"nevoroman","fullname":"Роман Неволин","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F21d\u002F1d5\u002F7d9\u002F21d1d57d92a296101a1da62761632a78.jpg","speciality":"DevRel"},"statistics":{"commentsCount":2,"favoritesCount":12,"readingCount":1101,"score":11,"votesCount":11},"hubs":[{"relatedData":null,"id":"15878","alias":"skbkontur","type":"corporative","title":"Блог компании Контур","titleHtml":"Блог компании Контур","isProfiled":false},{"relatedData":null,"id":"359","alias":"programming","type":"collective","title":"Программирование","titleHtml":"Программирование","isProfiled":true},{"relatedData":null,"id":"546","alias":"net","type":"collective","title":".NET","titleHtml":".NET","isProfiled":true},{"relatedData":null,"id":"20740","alias":"career","type":"collective","title":"Карьера в IT-индустрии","titleHtml":"Карьера в IT-индустрии","isProfiled":false},{"relatedData":null,"id":"20754","alias":"tech_events","type":"collective","title":"Конференции","titleHtml":"Конференции","isProfiled":false}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"3","alias":"management","title":"Менеджмент"},{"id":"4","alias":"marketing","title":"Маркетинг"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003EМы вместе с DotNetRu решили сделать базу знаний для .NET разработчиков. Собрать доступные в открытом доступе материалы по .NET и выбрать из них лучшие. Разбить все это по категориям и сложности, выстроить порядок изучения. А еще пригласить известных экспертов в каждой из тем, чтобы они помогли выбрать материалы и рассказали, что и почему вам будет полезно изучить.\u003C\u002Fp\u003E\u003Cp\u003EИ теперь мы по этому поводу будем проводить по два митапу раз в две недели — начиная уже с этой пятницы. Под катом будут детали, имена, даты и всякие пояснения, что и почему мы хотим сделать.\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F5dd\u002F71e\u002Fcc9\u002F5dd71ecc908ff997a1f46f440a9daaad.jpg","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F5dd\u002F71e\u002Fcc9\u002F5dd71ecc908ff997a1f46f440a9daaad.jpg","fit":"cover","positionY":0,"positionX":0}},"status":"published","plannedPublishTime":null,"checked":null,"tags":[{"titleHtml":"образование"},{"titleHtml":"dotnetru"},{"titleHtml":"opensource"},{"titleHtml":"обучение разработчика"}]}},"articlesIds":{"ARTICLES_LIST_TOP_PERIOD_DAILY":["580228","580124","580210","580270","575686","579778","580360","580204","580206","572164","580172","580336","580348","579590","580304","580214","580194","580164","580170","580374"]},"isLoading":false,"pagesCount":{"ARTICLES_LIST_TOP_PERIOD_DAILY":4},"route":{"name":"ARTICLES_LIST_TOP_PERIOD","params":{"period":"daily"},"query":{}},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":["578950","136375","135176"],"similarListRefs":{"135176":{"id":"135176","timePublished":"2012-01-16T14:48:42+00:00","isCorporative":false,"lang":"ru","titleHtml":"Hibernate cache","editorVersion":"1.0","postType":"article","postLabels":[],"author":{"id":"105775","alias":"doom369","fullname":"Дмитрий Думанский","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Ff1c\u002F77e\u002F6e0\u002Ff1c77e6e0483d780220171e95a390240.jpg","speciality":"Co-Founder в Blynk"},"statistics":{"commentsCount":28,"favoritesCount":342,"readingCount":127960,"score":26,"votesCount":26},"hubs":[{"id":"375","alias":"java","type":"collective","title":"Java","titleHtml":"Java","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка","titleHtml":"Разработка"}],"relatedData":null,"leadData":{"textHtml":"Довольно часто в java приложениях с целью снижения нагрузки на БД используют кеш. Не много людей реально понимают как работает кеш под капотом, добавить просто аннотацию не всегда достаточно, нужно понимать как работает система. Поэтому этой статье я попытаюсь раскрыть тему про то, как работает кеш популярного ORM фреймворка. Итак, для начала немного теории.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПрежде всего Hibernate cache — это 3 уровня кеширования:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E Кеш первого уровня (First-level cache);\u003C\u002Fli\u003E\r\n\u003Cli\u003E Кеш второго уровня (Second-level cache);\u003C\u002Fli\u003E\r\n\u003Cli\u003E Кеш запросов (Query cache);\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Ch5\u003EКеш первого уровня\u003C\u002Fh5\u003E\u003Cbr\u002F\u003E\r\nКеш первого уровня всегда привязан к объекту сессии. Hibernate всегда по умолчанию использует этот кеш и его нельзя отключить. Давайте сразу рассмотрим следующий код:\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003ESharedDoc persistedDoc = (SharedDoc) session.load(SharedDoc.class, docId);\nSystem.out.println(persistedDoc.getName());\nuser1.setDoc(persistedDoc);\n\npersistedDoc = (SharedDoc) session.load(SharedDoc.class, docId);\nSystem.out.println(persistedDoc.getName());\nuser2.setDoc(persistedDoc);\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nВозможно, Вы ожидаете, что будет выполнено 2 запроса в БД? Это не так. В этом примере будет выполнен 1 запрос в базу, несмотря на то, что делается 2 вызова load(), так как эти вызовы происходят в контексте одной сессии. Во время второй попытки загрузить план с тем же идентификатором будет использован кеш сессии. \u003Cbr\u002F\u003E\r\nОдин важный момент — при использовании метода load() Hibernate не выгружает из БД данные до тех пор пока они не потребуются. Иными словами — в момент, когда осуществляется первый вызов load, мы получаем прокси объект или сами данные в случае, если данные уже были в кеше сессии. Поэтому в коде присутствует getName() чтобы 100% вытянуть данные из БД. Тут также открывается прекрасная возможность для потенциальной оптимизации. В случае прокси объекта мы можем связать два объекта не делая запрос в базу, в отличии от метода get(). При использовании методов save(), update(), saveOrUpdate(), load(), get(), list(), iterate(), scroll() всегда будет задействован кеш первого уровня. Собственно, тут нечего больше добавить.\u003Cbr\u002F\u003E\r\n","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"status":"published","plannedPublishTime":null,"checked":null},"136375":{"id":"136375","timePublished":"2012-01-19T15:12:16+00:00","isCorporative":false,"lang":"ru","titleHtml":"Hibernate Cache. Практика","editorVersion":"1.0","postType":"article","postLabels":[],"author":{"id":"105775","alias":"doom369","fullname":"Дмитрий Думанский","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Ff1c\u002F77e\u002F6e0\u002Ff1c77e6e0483d780220171e95a390240.jpg","speciality":"Co-Founder в Blynk"},"statistics":{"commentsCount":12,"favoritesCount":139,"readingCount":16643,"score":19,"votesCount":21},"hubs":[{"id":"375","alias":"java","type":"collective","title":"Java","titleHtml":"Java","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка","titleHtml":"Разработка"}],"relatedData":null,"leadData":{"textHtml":"Итак, в продолжение \u003Ca href=\"http:\u002F\u002Fhabrahabr.ru\u002Fblogs\u002Fjava\u002F135176\u002F\"\u003Eпредыдущей статьи\u003C\u002Fa\u003E я попробую на реальных ситуациях рассказать о проблемах, которые возникали у меня при работе в реальных проектах.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch5\u003EМиграционные скрипты\u003C\u002Fh5\u003E\u003Cbr\u002F\u003E\r\nПожалуй, одной из наиболее частых проблем при работе с кешем в моем приложении является необходимость накатывать миграционные скрипты на работающий сервер. Ведь если эти скрипты запускаются не через фабрику сессий работающего сервера, то кеш этой фабрики никак не узнает об изменениях, которые делаются в базу. Следовательно, получаем проблему несовместимости данных. Для решения этой проблемы есть несколько путей:\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EРестарт сервера — самый простой и, обычно, самый не приемлемый способ;\u003C\u002Fli\u003E\r\n\u003Cli\u003EОчистка кеша через определенные механизмы — пожалуй самый оптимальный по простоте и надежности метод. Этот метод можно вынести, например в JMX, на веб страничку или другой интерфейс и вызывать при необходимости. Гибкость метода в том, что пишется это один раз, а используется сколько угодно и где угодно. В случае, если Ваш провайдер кеша — EHCache и класс провайдер — SingletonEhCacheProvider, то Ваш код может выглядеть так:\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epublic String dumpKeys() {\n    String regions[] = CacheManager.getInstance().getCacheNames();\n    StringBuilder allkeys = new StringBuilder();\n    String newLine = System.getProperty(&quot;line.separator&quot;);\n    for (String region : regions) {\n        Ehcache cache = CacheManager.getInstance().getEhcache(region);\n        allkeys.append(toSomeReadableString(cache.getKeys()));\n        allkeys.append(newLine);\n    }\n    return allkeys.toString();\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nЕстественно что этот код должен выполняться в том же процессе что и хибернейт, статистику которого Вы хотите отследить. Подробней можно прочитать \u003Ca href=\"http:\u002F\u002Fehcache.org\u002Fdocumentation\u002Frecipes\u002F\"\u003Eтут\u003C\u002Fa\u003E. Того же можно добиться используя фабрику сессий.\u003Cbr\u002F\u003E\r\n\u003C\u002Fli\u003E\r\n\u003Cli\u003EЗапуск миграционных скриптов, используя фабрику сессий работающего сервера. Это похоже на второй метод, с той лишь разницей, что мы не очищаем кеш, а пропускаем все миграционные скрипты через существующую фабрику. Таким образом все необходимые кеши обновляться сами. Этот метод рационально использовать в случае если кеш большой и дешевле его обновлять нежели создавать по новой;\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"status":"published","plannedPublishTime":null,"checked":null},"578950":{"id":"578950","timePublished":"2021-09-20T13:11:31+00:00","isCorporative":true,"lang":"ru","titleHtml":"Hibernate Proxy — для чего используются и как получить исходный объект","editorVersion":"2.0","postType":"article","postLabels":[{"type":"translation","data":{"originalAuthorName":"Thorben Janssen","originalUrl":"https:\u002F\u002Fthorben-janssen.com\u002Fhibernate-proxies\u002F"}}],"author":{"id":"1547287","alias":"MaxRokatansky","fullname":"OTUS","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Fb9f\u002Fbaf\u002F5f9\u002Fb9fbaf5f96ae52973706a0716bd9216e.jpg","speciality":"Редактор"},"statistics":{"commentsCount":0,"favoritesCount":18,"readingCount":1687,"score":8,"votesCount":9},"hubs":[{"id":"21052","alias":"otus","type":"corporative","title":"Блог компании OTUS","titleHtml":"Блог компании OTUS","isProfiled":false},{"id":"359","alias":"programming","type":"collective","title":"Программирование","titleHtml":"Программирование","isProfiled":true},{"id":"375","alias":"java","type":"collective","title":"Java","titleHtml":"Java","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка","titleHtml":"Разработка"}],"relatedData":null,"leadData":{"textHtml":"\u003Cp\u003EHibernate использует прокси-объекты для реализации ленивой загрузки (lazy load) связей \"к-одному\". Их также можно использовать для улучшения производительности некоторых операций записи.&nbsp;\u003C\u002Fp\u003E\u003Cp\u003EУпоминания прокси-объектов вы могли встречать при отладке или в логах. Имя класса прокси состоит из имени класса сущности и суффикса, который зависит от версии Hibernate и библиотеки для работы с байт-кодом, которую использует Hibernate.\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8ce\u002F031\u002Fe9a\u002F8ce031e9aab46c6ee1895c7f3f63b04a.png","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8ce\u002F031\u002Fe9a\u002F8ce031e9aab46c6ee1895c7f3f63b04a.png","fit":"cover","positionY":0,"positionX":0}},"status":"published","plannedPublishTime":null,"checked":null}}},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{"vlsergey":{"scoreStats":{"score":72.7,"votesCount":228},"rating":0,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"42070","alias":"vlsergey","fullname":"Сергей Владимиров","avatarUrl":null,"speciality":"Пользователь"}},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.670ab961.js" defer></script><script src="https://assets.habr.com/habr-web/js/chunk-f458c7c4.6e221df6.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.76acc47b.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
